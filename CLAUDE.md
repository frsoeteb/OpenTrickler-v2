# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

OpenTrickler v2 is embedded firmware for a Raspberry Pi Pico 2 W (RP2350) precision powder trickler controller. It runs FreeRTOS, controls stepper motors and scales via UART, and provides a web interface over WiFi. Languages: C11/C++17 with PIO assembly.

## Build Commands

```bash
# Full build (from repo root)
mkdir build && cd build
cmake -G Ninja -DPICO_BOARD=pico2_w ..
ninja

# Rebuild after changes (from build/)
ninja

# Build with color TFT display support (instead of default Mini 12864)
cmake -G Ninja -DPICO_BOARD=pico2_w -DUSE_TFT35=ON ..   # 3.5" 480x320
cmake -G Ninja -DPICO_BOARD=pico2_w -DUSE_TFT43=ON ..   # 4.3" 480x272
```

Output: `build/app.uf2` — flash by dragging onto the Pico in BOOTSEL mode.

Prerequisites: CMake 3.25+, Ninja, `gcc-arm-none-eabi`. Clone with `--recursive` for submodules.

## Architecture

**Entry point**: `src/app.cpp` — `main()` initializes all subsystems sequentially, then creates FreeRTOS tasks and starts the scheduler.

**FreeRTOS tasks** (created in main):
- WiFi maintenance task — pinned to core 0 (required for cyw43 driver stability)
- UI task — either LVGL (color TFT) or MUI menu (Mini 12864), selected at compile time via `USE_COLOR_TFT`
- Motor init task — initializes Trinamic stepper drivers, then runs motor control

**Conditional compilation**: The display system is selected at build time. `USE_TFT35`/`USE_TFT43` enables LVGL-based color UI (`lvgl_ui/`), otherwise the monochrome u8g2/MUI menu system is used. The `USE_COLOR_TFT` define gates shared code paths.

**WiFi**: Attempts home WiFi connection on boot. Falls back to AP mode (SSID: "OpenTrickler", IP: 192.168.4.1) with built-in DHCP/DNS servers. WiFi credentials persist in flash.

### Key Subsystems (all in `src/`)

| Module | Purpose |
|--------|---------|
| `charge_mode.cpp` | Core charging algorithm with PID control loop |
| `motors.c` | Trinamic TMC stepper control (coarse + fine) via UART |
| `scale.c` | Scale abstraction layer with pluggable drivers |
| `profile.c` | PID profile management (up to 8 profiles, stored in EEPROM) |
| `http_rest.c` | Custom HTTP server and REST API framework |
| `rest_endpoints.c` | REST endpoint registration |
| `wireless.c` | WiFi config (AP/STA modes), credentials in flash |
| `eeprom.c` | CAT24C256 I2C EEPROM for persistent settings |
| `error.c` | Centralized error system with codes by module (1xx=EEPROM, 2xx=Display, etc.) |
| `ai_tuning.c` | ML-based PID auto-tuning |
| `servo_gate.c` | Servo gate PWM control |
| `neopixel_led.c` | WS2812B LED via PIO |

### Scale Driver Pattern

Scale drivers are pluggable: each driver file (`and_scale.c`, `steinberg_scale.c`, `gng_scale.c`, `ussolid_scale.c`, `jm_science_scale.c`, `creedmoor_scale.c`, `radwag_scale.c`) implements the `scale_handle_t` interface with `read_loop_task` and `force_zero` function pointers. Driver selection is configured via EEPROM and `scale_driver_t` enum.

### Display Architecture

- **Mini 12864** (default): `mini_12864_module.cpp` + `menu.cpp` using u8g2/MUI libraries
- **Color TFT**: `tft35/` directory contains SPI display driver (ST7796/ILI9488) and XPT2046 touch driver. `lvgl_ui/` contains LVGL screen implementations (`ui_*.cpp` files, one per screen)

### Code Generation (build-time)

- HTML files in `html/` are converted to C headers via `scripts/html2header.py` → `src/generated/*.html.h`
- PIO programs (`ws2812.pio`, `stepper.pio`) generate headers → `src/generated/*.pio.h`
- Version info generated by `scripts/gen_version.py` → `src/generated/version.c/h`

## Pin Definitions

All GPIO pin assignments are in `targets/raspberrypi_pico_w_config.h`. RP2350-specific overrides in `targets/pico2_w.h`.

## Submodules (in `library/`)

- `pico-sdk` — Raspberry Pi Pico SDK
- `FreeRTOS-Kernel` — with platform-specific port auto-selected (RP2040/RP2350 ARM/RISC-V)
- `u8g2` — Monochrome graphics library
- `Trinamic-library` — Stepper motor driver library (custom CMake integration, not using library's own CMakeLists)
- `lvgl` — Color display graphics library

## C/C++ Interop

Many C++ files call C functions. C headers use `extern "C"` guards. The `dhcpserver.h` and `dnsserver.h` headers are wrapped in `extern "C"` blocks at the call site in `app.cpp`.
