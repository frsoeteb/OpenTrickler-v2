// ---------------------------------------------------------- //
// This file is autogenerated by html2header.py; do not edit! //
// ---------------------------------------------------------- //

#ifndef WEB_PORTAL_HTML_H_
#define WEB_PORTAL_HTML_H_

const char html_web_portal_html[] = "HTTP/1.1 200 OK\r\nContent-Type: text/html\r\n\r\n<!DOCTYPE html>\n<html data-theme=\"dark\">\n\n<head>\n    <meta charset=\"UTF-8\">\n    <title>OpenTrickler Web Controller</title>\n\n    <link href=\"styles.css\" rel=\"stylesheet\" type=\"text/css\" />\n\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0 viewport-fit=cover\">\n    <link rel=\"icon\" href=\"/favicon.ico\">\n\n    <style>\n        /* Exclude the pixels taken by the bottom nav bar */\n        .exclude-bottom-nav {\n            padding-bottom: 64px;\n        }\n        /* Fix drawer menu scrolling */\n        #drawerSlide {\n            max-height: calc(100vh - 64px) !important;\n            max-height: calc(100dvh - 64px) !important;\n            overflow-y: auto !important;\n            overflow-x: hidden !important;\n            flex-wrap: nowrap !important;\n        }\n        #drawerSlide li {\n            width: 100% !important;\n        }\n    </style>\n\n    <style>\n        /* Theme toggle button */\n        .theme-toggle {\n            position: fixed;\n            top: 10px;\n            right: 10px;\n            z-index: 1000;\n        }\n    </style>\n    <script>\n        // Load saved theme or default to dark\n        (function() {\n            const saved = localStorage.getItem(\'theme\') || \'dark\';\n            document.documentElement.setAttribute(\'data-theme\', saved);\n        })();\n        \n        function toggleTheme() {\n            const current = document.documentElement.getAttribute(\'data-theme\');\n            const next = current === \'dark\' ? \'light\' : \'dark\';\n            document.documentElement.setAttribute(\'data-theme\', next);\n            localStorage.setItem(\'theme\', next);\n            updateThemeIcon();\n        }\n        \n        function updateThemeIcon() {\n            const theme = document.documentElement.getAttribute(\'data-theme\');\n            const btn = document.getElementById(\'themeToggleBtn\');\n            if (btn) {\n                btn.innerHTML = theme === \'dark\' ? \'Light\' : \'Dark\';\n            }\n        }\n    </script>\n</head>\n\n<body>\n\n    <button id=\"themeToggleBtn\" class=\"btn btn-circle btn-ghost theme-toggle\" onclick=\"toggleTheme()\">Dark</button>\n    <script>updateThemeIcon();</script>\n\n<div class=\"container mx-auto\">\n    <!-- The Trickle Control Page -->\n    <section id=\"sectionTrickler\">\n        <div class=\"grid grid-cols-1 exclude-bottom-nav\">\n            <!-- Row 1 -->\n            <div class=\"grid grid-cols-2\">\n\n                <!-- Stat 1: Current Weight  -->\n                <div class=\"stat\">\n                    <div class=\"stat-title\">Current Weight</div>\n                    <div id=\"currentWeightDecimal\" class=\"stat-value\">---</div>\n                    <div id=\"profileName\" class=\"stat-desc text-primary\" onclick=\"onProfileNameClicked()\">Unknown Profile</div>\n                    <div class=\"stat-desc\">\n                        <progress id=\"currentWeightProgressPencentage\" class=\"progress progress-primary\" value=\"100\" max=\"100\"></progress>\n                    </div>\n                </div>\n\n                <!-- Stat 2: Charging Time -->\n                <div class=\"stat text-right\">\n                    <div class=\"stat-title\">Charging Time</div>\n                    <div id=\"chargeTimeValue\" class=\"stat-value\">-.-- s</div>\n                    <!-- These two lines are placeholders to ensure vertical alignment -->\n                    <div class=\"stat-desc\"> </div>\n                    <div class=\"stat-desc\"> </div>\n                </div>\n\n            </div>\n\n            <!-- Charge Mode Control -->\n            <section id=\"sectionTricklerChargeMode\">\n                <div class=\"grid grid-cols-1 gap-2 px-4\">\n                    <!-- Row 1 -->\n                    <div class=\"divider\">Charge Control</div>\n                    \n                    <!-- Row 2 -->\n                    <ul class=\"steps\">\n                        <li id=\"chargeModeStateWait\" class=\"step step-primary\">Wait</li>\n                        <li id=\"chargeModeStateCharging\" class=\"step\">Charging</li>\n                        <li id=\"chargeModeStateRemoveCup\" class=\"step\">Remove Cup</li>\n                        <li id=\"chargeModeStateReturnCup\" class=\"step\">Return Cup</li>\n                    </ul>\n\n                    <!-- Row 3 -->\n                    <input id=\"chargeWeightInput\" type=\"number\" step=\"0.001\" placeholder=\"Charge Weight\" class=\"input input-bordered input-primary\" pattern=\"[0-9]+([\\.,][0-9]+)?\"/>\n\n                    <!-- Row 4 -->\n                    <div class=\"grid grid-cols-2 gap-2\">\n                        <button id=\"confirmButton\" class=\"btn btn-primary btn-lg\" onclick=\"setChargeWeight()\">Start</button>\n                        <button id=\"stopButton\" class=\"btn btn-warning btn-lg\" onclick=\"enterChargeMode(false)\" disabled=\"disabled\">Stop</button>\n                    </div>\n                </div>\n            </section>\n\n            <!-- Cleanup Mode Control -->\n            <section id=\"sectionTricklerCleanUpMode\" style=\"display: none;\">\n                <div class=\"grid grid-cols-1 gap-2 px-4\">\n                    <div class=\"grid grid-cols-1 gap-2\"> \n                        <span class=\"label-text\">Trickler Speed (rps)</span>\n                        <input id=\"tricklerSpeedSlider\" type=\"range\" min=\"-5\" max=\"5\" value=\"0\" class=\"range range-lg\" step=\"0.1\" oninput=\"debouncedOnTricklerSpeedUpdate()\"/>\n                        <button class=\"btn btn-primary w-full\" onclick=\"onStopCleanupButtonClicked()\">Stop</button>\n                    </div>\n                </div>\n            </section>\n\n            <div class=\"grid grid-cols-1 gap-2 px-4\">\n                <div class=\"divider\">General Control</div>\n                <div class=\"grid grid-cols-1 gap-2\">\n                    <button class=\"btn btn-neutral\" onclick=\"scaleForceZero()\">Scale Zero</button>\n\n                    <div class=\"grid grid-cols-2 gap-2\">\n                        <button class=\"btn btn-neutral\" onclick=\"servoGateSetState(2)\">Gate Open</button>\n                        <button class=\"btn btn-neutral\" onclick=\"servoGateSetState(1)\">Gate Close</button>\n                    </div>\n\n                    <div class=\"grid grid-cols-2 gap-2\">\n                        <button class=\"btn btn-success\" onclick=\"setPicoLed(true)\">LED On</button>\n                        <button class=\"btn btn-neutral\" onclick=\"setPicoLed(false)\">LED Off</button>\n                    </div>\n                </div>\n            </div>\n\n        </div>\n    </section>\n\n    <!-- The Settings Page -->\n    <section id=\"sectionSettings\" style=\"display: none;\">\n        <div class=\"drawer\">\n            <input id=\"settingsDrawer\" type=\"checkbox\" class=\"drawer-toggle\" /> \n            <div class=\"drawer-content exclude-bottom-nav\">\n                <!-- Navbar, fixed at the top-->\n                <div class=\"w-full navbar sticky top-0 bg-base-100\">\n                    <div class=\"flex-none\">\n                        <label for=\"settingsDrawer\" aria-label=\"open sidebar\" class=\"btn btn-square btn-ghost\">\n                            <svg xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\" class=\"inline-block w-6 h-6 stroke-current\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M4 6h16M4 12h16M4 18h16\"></path></svg>\n                        </label>\n                    </div> \n                    <div id=\"settingsSectionTitle\" class=\"w-full px-2 mx-2\">---</div>\n                    <div id=\"navVersion\" class=\"badge badge-ghost text-xs\">v?.?</div>\n                </div>\n\n                <div class=\"grid grid-cols-1 px-6 gap-2\">\n                    <!-- Scale Settings -->\n                    <section class=\"settings-page\" id=\"settings-scale\" name=\"Scale\">\n                        <form id=\"scaleConfigForm\" action=\"/rest/scale_config\" class=\"grid grid-cols-1 gap-3\">\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Scale Driver</span>\n                                <select class=\"select select-bordered\" name=\"s0\">\n                                    <option value=\"0\">AND FX-i and FZ-i</option>\n                                    <option value=\"1\">Steinberg SBS</option>\n                                    <option value=\"2\">GNG JJB</option>\n                                    <option value=\"3\">US Solid JFDBS</option>\n                                    <option value=\"4\">JM Science</option>\n                                    <option value=\"5\">Creedmoore</option>\n                                    <option value=\"6\">Radwag PS R2</option>\n                                </select>\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Serial Baudrate</span>\n                                <select class=\"select select-bordered\" name=\"s1\">\n                                    <option value=\"0\">4800</option>\n                                    <option value=\"1\">9600</option>\n                                    <option value=\"2\">19200</option>\n                                </select>\n                            </div>\n\n                            <button class=\"btn btn-neutral settings-apply-btn\">Apply</button>\n                        </form>\n                    </section>\n\n                    <!-- Profile Settings -->\n                    <section class=\"settings-page\" id=\"settings-profile\" name=\"Profiles\" style=\"display: none;\">\n                        <form id=\"profileConfigForm\" action=\"/rest/profile_config\" class=\"grid grid-cols-1 gap-3\">\n                            <div class=\"grid grid-cols-1 gap-2\">\n                                <div role=\"alert\" class=\"alert\">\n                                    <svg\n                                        xmlns=\"http://www.w3.org/2000/svg\"\n                                        fill=\"none\"\n                                        viewBox=\"0 0 24 24\"\n                                        class=\"h-6 w-6 shrink-0 stroke-current\">\n                                        <path\n                                            stroke-linecap=\"round\"\n                                            stroke-linejoin=\"round\"\n                                            stroke-width=\"2\"\n                                            d=\"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\">\n                                        </path>\n                                    </svg>\n                                    <a href=\"https://github.com/eamars/OpenTrickler/blob/main/Manual/tuning_guide.md\" class=\"link\">Powder Profile Tuning Guide</a>\n                                </div>\n\n                                <span class=\"label-text\">Select Profile</span>\n                                <select class=\"select select-bordered select-primary\" name=\"pf\" onchange=\"populateProfileSelection(this)\" id=\"select_profile_option\">\n                                    <option value=\"0\">#0</option>\n                                    <option value=\"1\">#1</option>\n                                    <option value=\"2\">#2</option>\n                                    <option value=\"3\">#3</option>\n                                    <option value=\"4\">#4</option>\n                                    <option value=\"5\">#5</option>\n                                    <option value=\"6\">#6</option>\n                                    <option value=\"7\">#7</option>\n                                </select>\n\n                                <button class=\"btn btn-neutral system-control-export-btn\" onclick=\"onExportProfileBtnClicked(event)\">Export Profile</button>\n                            </div>\n\n                            <div class=\"divider\"></div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Profile Name</span>\n                                <input type=\"text\" class=\"input input-bordered\" name=\"p2\" maxlength=\"16\">\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Coarse Trickler Kp</span>\n                                <input type=\"number\" class=\"input input-bordered\" name=\"p3\" step=\"0.001\">\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Coarse Trickler Ki</span>\n                                <input type=\"number\" class=\"input input-bordered\" name=\"p4\" step=\"0.001\">\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Coarse Trickler Kd</span>\n                                <input type=\"number\" class=\"input input-bordered\" name=\"p5\" step=\"0.001\">\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Coarse Trickler Min Flow Speed (rps)</span>\n                                <input type=\"number\" class=\"input input-bordered\" name=\"p6\" step=\"0.001\">\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Coarse Trickler Max Flow Speed (rps)</span>\n                                <input type=\"number\" class=\"input input-bordered\" name=\"p7\" step=\"0.001\">\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Fine Trickler Kp</span>\n                                <input type=\"number\" class=\"input input-bordered\" name=\"p8\" step=\"0.001\">\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Fine Trickler Ki</span>\n                                <input type=\"number\" class=\"input input-bordered\" name=\"p9\" step=\"0.001\">\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Fine Trickler Kd</span>\n                                <input type=\"number\" class=\"input input-bordered\" name=\"p10\" step=\"0.001\">\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Fine Trickler Min Flow Speed (rps)</span>\n                                <input type=\"number\" class=\"input input-bordered\" name=\"p11\" step=\"0.001\">\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Fine Trickler Max Flow Speed (rps)</span>\n                                <input type=\"number\" class=\"input input-bordered\" name=\"p12\" step=\"0.001\">\n                            </div>\n\n                            <button class=\"btn btn-neutral settings-apply-btn\">Apply</button>\n                        </form>\n                    </section>\n\n                    <!-- Charge Mode Settings -->\n                    <section class=\"settings-page\" id=\"settings-charge-mode\" name=\"Charge Mode\" style=\"display: none;\">\n                        <form id=\"chargeModeConfigForm\" action=\"/rest/charge_mode_config\" class=\"grid grid-cols-1 gap-3\">\n                            <div class=\"grid grid-cols-2 gap-1\">\n                                <span class=\"label-text\">Neopixel LED Normal Charge Colour</span>\n                                <input type=\"color\" class=\"input w-full\" name=\"c1\">\n                            </div>\n\n                            <div class=\"grid grid-cols-2 gap-1\">\n                                <span class=\"label-text\">Neopixel LED Under Charge Colour</span>\n                                <input type=\"color\" class=\"input w-full\" name=\"c2\">\n                            </div>\n\n                            <div class=\"grid grid-cols-2 gap-1\">\n                                <span class=\"label-text\">Neopixel LED Over Charge Colour</span>\n                                <input type=\"color\" class=\"input w-full\" name=\"c3\">\n                            </div>\n\n                            <div class=\"grid grid-cols-2 gap-1\">\n                                <span class=\"label-text\">Neopixel LED Not Ready Colour</span>\n                                <input type=\"color\" class=\"input w-full\" name=\"c4\">\n                            </div>\n\n                            <div class=\"divider\"></div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Set Point Accuracy (Standard Deviation)</span>\n                                <input type=\"number\" class=\"input input-bordered\" name=\"c7\" step=\"0.001\">\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Set Point Accuracy (Mean)</span>\n                                <input type=\"number\" class=\"input input-bordered\" name=\"c8\" step=\"0.001\">\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Decimal Places</span>\n                                <select class=\"select select-bordered\" name=\"c9\">\n                                    <option value=\"0\">2</option>\n                                    <option value=\"1\">3</option>\n                                </select>\n                            </div>\n\n                            <div class=\"divider\"></div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Enable Pre-Charge (requires servo gate)</span>\n                                <select class=\"select select-bordered\" name=\"c10\">\n                                    <option value=\"true\">Yes</option>\n                                    <option value=\"false\">No</option>\n                                </select>\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Pre-Charge Duration (ms)</span>\n                                <input type=\"number\" class=\"input input-bordered\" name=\"c11\" step=\"1\">\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Pre-Charge Speed (rps)</span>\n                                <input type=\"number\" class=\"input input-bordered\" name=\"c12\" step=\"0.001\">\n                            </div>\n\n                            <button class=\"btn btn-neutral settings-apply-btn\">Apply</button>\n                        </form>\n                    </section>\n\n                    <!-- WiFi Settings -->\n                    <section class=\"settings-page\" id=\"settings-wifi\" name=\"WiFi\" style=\"display: none;\">\n                        <form id=\"wirelessConfigForm\" action=\"/rest/wireless_config\" class=\"grid grid-cols-1 gap-3\">\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">WiFi SSID</span>\n                                <input type=\"text\" class=\"input input-bordered\" name=\"w0\" maxlength=\"32\">\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <div>\n                                    <div class=\"badge badge-neutral\">Write Only</div>\n                                    <span class=\"label-text\">WiFi Password</span> \n                                </div>\n                                <input type=\"password\" class=\"input input-bordered\" name=\"w1\" maxlength=\"63\" placeholder=\"********\">\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">WiFi Authentication Method</span>\n                                <select class=\"select select-bordered\" name=\"w2\">\n                                    <option value=\"0\">None</option>\n                                    <option value=\"1\">WPA-TKIP</option>\n                                    <option value=\"2\">WPA2-AES</option>\n                                    <option value=\"3\">WPA2-MIXED</option>\n                                </select>\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">WiFi Attempt to Connect Timeout (ms)</span>\n                                <input type=\"number\" class=\"input input-bordered\" name=\"w3\" step=\"1000\">\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Enable WiFi</span>\n                                <select class=\"select select-bordered\" name=\"w4\">\n                                    <option value=\"true\">Yes</option>\n                                    <option value=\"false\">No</option>\n                                </select>\n                            </div>\n\n                            <button class=\"btn btn-neutral settings-apply-btn\">Apply</button>\n                            <button type=\"button\" class=\"btn btn-error\" onclick=\"resetToAP()\">Reset to AP Mode</button>\n                        </form>\n                    </section>\n\n                    <!-- Coarse Trickler Motor Settings -->\n                    <section class=\"settings-page\" id=\"settings-coarse-motor\" name=\"Coarse Trickler Motor\" style=\"display: none;\">\n                        <form id=\"coarseMotorConfigForm\" action=\"/rest/coarse_motor_config\" class=\"grid grid-cols-1 gap-3\">\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Angular Acceleration (rps/s)</span>\n                                <input type=\"number\" class=\"input input-bordered\" name=\"m0\" step=\"0.001\">\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Full Steps per Rotation</span>\n                                <select class=\"select select-bordered\" name=\"m1\">\n                                    <option value=\"200\">200</option>\n                                    <option value=\"400\">400</option>\n                                </select>\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Current (mA)</span>\n                                <input type=\"number\" class=\"input input-bordered\" name=\"m2\" step=\"1\">\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Microsteps</span>\n                                <select class=\"select select-bordered\" name=\"m3\">\n                                    <option value=\"16\">16</option>\n                                    <option value=\"32\">32</option>\n                                    <option value=\"64\">64</option>\n                                    <option value=\"128\">128</option>\n                                    <option value=\"256\">256</option>\n                                </select>\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Max Speed (rps)</span>\n                                <input type=\"number\" class=\"input input-bordered\" name=\"m4\" step=\"0.001\">\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Min Speed (rps)</span>\n                                <input type=\"number\" class=\"input input-bordered\" name=\"m6\" step=\"0.001\"> \n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Current Sensing Resistor (mOhm)</span>\n                                <input type=\"number\" class=\"input input-bordered\" name=\"m5\" step=\"1\"> \n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Gear Ratio</span>\n                                <input type=\"number\" class=\"input input-bordered\" name=\"m7\" step=\"0.0000001\"> \n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Inverted Enable Pin</span>\n                                <select class=\"select select-bordered\" name=\"m8\">\n                                    <option value=\"true\">Yes</option>\n                                    <option value=\"false\">No</option>\n                                </select>\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Inverted Step Direction Pin</span>\n                                <select class=\"select select-bordered\" name=\"m9\">\n                                    <option value=\"true\">Yes</option>\n                                    <option value=\"false\">No</option>\n                                </select>\n                            </div>\n\n                            <button class=\"btn btn-neutral settings-apply-btn\">Apply</button>\n                        </form> \n                    </section>\n\n                    <!-- Fine Trickler motor Settings -->\n                    <section class=\"settings-page\" id=\"settings-fine-motor\" name=\"Fine Trickler Motor\" style=\"display: none;\">\n                        <form id=\"fineMotorConfigForm\" action=\"/rest/fine_motor_config\" class=\"grid grid-cols-1 gap-3\">\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Angular Acceleration (rps/s)</span>\n                                <input type=\"number\" class=\"input input-bordered\" name=\"m0\" step=\"0.001\">\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Full Steps per Rotation</span>\n                                <select class=\"select select-bordered\" name=\"m1\">\n                                    <option value=\"200\">200</option>\n                                    <option value=\"400\">400</option>\n                                </select>\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Current (mA)</span>\n                                <input type=\"number\" class=\"input input-bordered\" name=\"m2\" step=\"1\">\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Microsteps</span>\n                                <select class=\"select select-bordered\" name=\"m3\">\n                                    <option value=\"16\">16</option>\n                                    <option value=\"32\">32</option>\n                                    <option value=\"64\">64</option>\n                                    <option value=\"128\">128</option>\n                                    <option value=\"256\">256</option>\n                                </select>\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Max Speed (rps)</span>\n                                <input type=\"number\" class=\"input input-bordered\" name=\"m4\" step=\"0.001\">\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Min Speed (rps)</span>\n                                <input type=\"number\" class=\"input input-bordered\" name=\"m6\" step=\"0.001\"> \n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Current Sensing Resistor (mOhm)</span>\n                                <input type=\"number\" class=\"input input-bordered\" name=\"m5\" step=\"1\"> \n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Gear Ratio</span>\n                                <input type=\"number\" class=\"input input-bordered\" name=\"m7\" step=\"0.0000001\"> \n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Inverted Enable Pin</span>\n                                <select class=\"select select-bordered\" name=\"m8\">\n                                    <option value=\"true\">Yes</option>\n                                    <option value=\"false\">No</option>\n                                </select>\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Inverted Step Direction Pin</span>\n                                <select class=\"select select-bordered\" name=\"m9\">\n                                    <option value=\"true\">Yes</option>\n                                    <option value=\"false\">No</option>\n                                </select>\n                            </div>\n\n                            <button class=\"btn btn-neutral settings-apply-btn\">Apply</button>\n                        </form> \n                    </section>\n\n                    <!-- Neopxiel LED Settings -->\n                    <section class=\"settings-page\" id=\"settings-neopixel-led\" name=\"Neopixel LED\" style=\"display: none;\">\n                        <form id=\"neopixelLedConfigForm\" action=\"/rest/neopixel_led_config\" class=\"grid grid-cols-1 gap-3\">\n                            <div role=\"alert\" class=\"alert\">\n                                <svg xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\" class=\"stroke-current shrink-0 w-6 h-6\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\"></path></svg>\n                                <span>The default Neopxiel LED colour can be overridden by Charge Mode Functions.</span>\n                            </div>\n\n                            <div class=\"grid grid-cols-2 gap-1\">\n                                <span class=\"label-text\">Mini 12864 Display Background Colour</span>\n                                <input type=\"color\" class=\"input w-full\" name=\"bl\">\n                            </div>\n\n                            <div class=\"grid grid-cols-2 gap-1\">\n                                <span class=\"label-text\">LED1 Default Colour</span>\n                                <input type=\"color\" class=\"input w-full\" name=\"l1\">\n                            </div>\n\n                            <div class=\"grid grid-cols-2 gap-1\">\n                                <span class=\"label-text\">LED2 Default Colour</span>\n                                <input type=\"color\" class=\"input w-full\" name=\"l2\">\n                            </div>\n\n                            <div class=\"divider\"></div>\n\n                            <div class=\"grid grid-cols-2 gap-1\">\n                                <span class=\"label-text\">PWM OUT Chain Count</span>\n                                <select class=\"select select-bordered\" name=\"l3\">\n                                    <option value=\"1\">1</option>\n                                    <option value=\"2\">2</option>\n                                    <option value=\"3\">3</option>\n                                    <option value=\"4\">4</option>\n                                    <option value=\"5\">5</option>\n                                    <option value=\"6\">6</option>\n                                    <option value=\"7\">7</option>\n                                    <option value=\"8\">8</option>\n                                    <option value=\"9\">9</option>\n                                    <option value=\"10\">10</option>\n                                    <option value=\"11\">11</option>\n                                    <option value=\"12\">12</option>\n                                    <option value=\"13\">13</option>\n                                    <option value=\"14\">14</option>\n                                    <option value=\"15\">15</option>\n                                    <option value=\"16\">16</option>\n                                </select>\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">PWM OUT Is RGBW LED? (WS2812B or SK6812)</span>\n                                <select class=\"select select-bordered\" name=\"l4\">\n                                    <option value=true>Yes</option>\n                                    <option value=false>No</option>\n                                </select>\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">PWM OUT Neopixel LED Colour Order</span>\n                                <select class=\"select select-bordered\" name=\"l5\">\n                                    <option value=\"0\">RGB</option>\n                                    <option value=\"1\">GRB</option>\n                                </select>\n                            </div>\n\n                            <button class=\"btn btn-neutral settings-apply-btn\">Apply</button>\n                        </form>\n                    </section>\n\n                    <!-- Display Type Selection -->\n                    <section class=\"settings-page\" id=\"settings-display\" name=\"Display\" style=\"display: none;\">\n                        <form id=\"displayConfigForm\" action=\"/rest/display_config\" class=\"grid grid-cols-1 gap-3\">\n                            <div role=\"alert\" class=\"alert alert-info\">\n                                <svg xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\" class=\"h-6 w-6 shrink-0 stroke-current\">\n                                    <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\"></path>\n                                </svg>\n                                <span>Changing display type requires a reboot.</span>\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Display Type</span>\n                                <select class=\"select select-bordered\" name=\"d0\" id=\"displayTypeSelect\" onchange=\"onDisplayTypeChanged()\">\n                                    <option value=\"0\">Mini 12864 (128x64 Monochrome)</option>\n                                    <option value=\"1\">TFT35 V3.0.1 (480x320 Color Touch)</option>\n                                    <option value=\"2\">TFT43 V3.0 (480x272 Color Touch)</option>\n                                </select>\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Rotation</span>\n                                <select class=\"select select-bordered\" name=\"d1\" id=\"displayRotationSelect\">\n                                    <option value=\"0\">0°</option>\n                                    <option value=\"1\">90°</option>\n                                    <option value=\"2\">180°</option>\n                                    <option value=\"3\">270°</option>\n                                </select>\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\" id=\"brightnessGroup\">\n                                <span class=\"label-text\">Brightness</span>\n                                <input type=\"range\" name=\"d2\" id=\"displayBrightnessSlider\" min=\"0\" max=\"255\" value=\"255\" class=\"range range-primary\" oninput=\"updateBrightnessLabel()\">\n                                <span class=\"label-text text-center\" id=\"brightnessLabel\">255</span>\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\" id=\"encoderGroup\">\n                                <span class=\"label-text\">Inverted Encoder Direction</span>\n                                <select class=\"select select-bordered\" name=\"d3\">\n                                    <option value=\"false\">No</option>\n                                    <option value=\"true\">Yes</option>\n                                </select>\n                            </div>\n\n                            <button class=\"btn btn-neutral settings-apply-btn\">Apply</button>\n                            <button type=\"button\" class=\"btn btn-warning\" onclick=\"saveDisplayAndReboot()\">Save & Reboot</button>\n                        </form>\n                    </section>\n\n                    <!-- Mini 12864 Module Settings -->\n                    <section class=\"settings-page\" id=\"settings-mini-12864-module\" name=\"Mini 12864 Module\" style=\"display: none;\">\n                        <form id=\"mini12864ModuleConfigForm\" action=\"/rest/mini_12864_config\" class=\"grid grid-cols-1 gap-3\">\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Inverted Rotary Button Direction</span>\n                                <select class=\"select select-bordered\" name=\"b0\">\n                                    <option value=\"true\">Yes</option>\n                                    <option value=\"false\">No</option>\n                                </select>\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Display Rotation (deg)</span>\n                                <select class=\"select select-bordered\" name=\"b1\">\n                                    <option value=\"0\">0</option>\n                                    <option value=\"2\">180</option>\n                                </select>\n                            </div>\n\n                            <button class=\"btn btn-neutral settings-apply-btn\">Apply</button>\n                        </form>\n                    </section>\n\n                    <section class=\"settings-page\" id=\"settings-servo-gate\" name=\"Servo Gate\" style=\"display: none;\">\n                        <form id=\"servoGateConfigForm\" action=\"/rest/servo_gate_config\" class=\"grid grid-cols-1 gap-3\">\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Servo Gate Enable</span>\n                                <select class=\"select select-bordered\" name=\"c0\">\n                                    <option value=\"true\">Yes</option>\n                                    <option value=\"false\">No</option>\n                                </select>\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Shutter 0 Close Duty Cycle</span>\n                                <input type=\"number\" class=\"input input-bordered\" name=\"c1\" step=\"0.001\">\n                            </div>\n                            \n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Shutter 0 Open Duty Cycle</span>\n                                <input type=\"number\" class=\"input input-bordered\" name=\"c2\" step=\"0.001\">\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Shutter 1 Close Duty Cycle</span>\n                                <input type=\"number\" class=\"input input-bordered\" name=\"c3\" step=\"0.001\">\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Shutter 1 Open Duty Cycle</span>\n                                <input type=\"number\" class=\"input input-bordered\" name=\"c4\" step=\"0.001\">\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Shutter Close Speed (%/s)</span>\n                                <input type=\"number\" class=\"input input-bordered\" name=\"c5\" step=\"0.001\">\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Shutter Open Speed (%/s)</span>\n                                <input type=\"number\" class=\"input input-bordered\" name=\"c6\" step=\"0.001\">\n                            </div>\n\n                            <button class=\"btn btn-neutral settings-apply-btn\">Apply</button>\n                        </form>\n                    </section>\n\n                    <!-- System Control Page -->\n                    \n                    <!-- Motors Settings -->\n                    <section class=\"settings-page\" id=\"settings-motors\" name=\"Motors\" style=\"display: none;\">\n                        <div class=\"grid grid-cols-1 gap-3\">\n                            <div class=\"alert\" id=\"motorsStatusAlert\">\n                                <span id=\"motorsStatusText\">Loading...</span>\n                            </div>\n                            \n                            <div class=\"form-control\">\n                                <label class=\"label cursor-pointer\">\n                                    <span class=\"label-text\">Motors Enabled</span>\n                                    <input type=\"checkbox\" id=\"motorsEnabledToggle\" class=\"toggle toggle-primary\" onchange=\"onMotorsEnabledChange()\"/>\n                                </label>\n                            </div>\n                            \n                            <div class=\"text-sm opacity-70\">\n                                Changes require reboot to take effect.\n                            </div>\n                        </div>\n                    </section>\n\n                    <section class=\"settings-page\" id=\"settings-system-control\" name=\"System Control\" style=\"display: none;\">\n                        <form id=\"systemControlForm\" action=\"/rest/system_control\" class=\"grid grid-cols-1 gap-3\">\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Unique ID</span>\n                                <input type=\"text\" class=\"input input-bordered\" name=\"s0\" disabled=\"disabled\" readonly>\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Firmware Version</span>\n                                <input type=\"text\" class=\"input input-bordered\" name=\"s1\" disabled=\"disabled\" readonly>\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">VCS Hash</span>\n                                <input type=\"text\" class=\"input input-bordered\" name=\"s2\" disabled=\"disabled\" readonly>\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Build Type</span>\n                                <input type=\"text\" class=\"input input-bordered\" name=\"s3\" disabled=\"disabled\" readonly>\n                            </div>\n\n                            <div class=\"divider\"></div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Save All Changes to EEPROM</span>\n                                <select class=\"select select-bordered\" name=\"s4\">\n                                    <option value=\"true\">Yes</option>\n                                    <option value=\"false\">No</option>\n                                </select>\n                            </div>\n\n                            \n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Reboot</span>\n                                <select class=\"select select-bordered\" name=\"s5\">\n                                    <option value=\"true\">Yes</option>\n                                    <option value=\"false\">No</option>\n                                </select>\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <div>\n                                    <div class=\"badge badge-warning\">Warning</div>\n                                    <span class=\"label-text\">Erase EEPROM</span> \n                                </div>\n                                <select class=\"select select-bordered\" name=\"s6\">\n                                    <option value=\"true\">Yes</option>\n                                    <option value=\"false\">No</option>\n                                </select>\n                            </div>\n\n                            <button class=\"btn btn-neutral system-control-apply-btn\" id=\"system_control_apply_btn\">Apply</button>\n                        </form>\n\n                        <div class=\"divider\"></div>\n\n                        <!-- Export and Import config -->\n                        <div class=\"grid grid-cols-2 gap-1\">\n                            <button class=\"btn btn-neutral system-control-export-btn\" onclick=\"onExportConfigClicked()\">Export Config</button>\n                            <button class=\"btn btn-neutral system-control-import-btn\" onclick=\"onImportConfigClicked()\">Import Config</button>\n                        </div>\n\n                    </section>\n\n                    <!-- Errors Page -->\n                    <section class=\"settings-page\" id=\"settings-errors\" name=\"Errors\" style=\"display: none;\">\n                        <div class=\"grid grid-cols-1 gap-3\">\n                            <div class=\"flex justify-between items-center\">\n                                <span id=\"errorCountBadge\" class=\"badge badge-error\">0 errors</span>\n                                <button class=\"btn btn-sm btn-outline\" onclick=\"clearErrors()\">Clear All</button>\n                            </div>\n\n                            <div id=\"errorListContainer\" class=\"grid grid-cols-1 gap-2\">\n                                <div class=\"text-center text-gray-500\">No errors</div>\n                            </div>\n\n                            <button class=\"btn btn-neutral\" onclick=\"refreshErrors()\">Refresh</button>\n                        </div>\n                    </section>\n\n                    <!-- AI Tuning Page -->\n                    <section class=\"settings-page\" id=\"settings-ai-tuning\" name=\"PID Auto-Tuning\" style=\"display: none;\">\n                        <div class=\"grid grid-cols-1 gap-3\">\n                            <div role=\"alert\" class=\"alert\">\n                                <svg xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\" class=\"h-6 w-6 shrink-0 stroke-current\">\n                                    <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\"></path>\n                                </svg>\n                                <span>Auto-tune PID parameters for coarse and fine tricklers. Place powder in hopper before starting.</span>\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Select Profile</span>\n                                <select class=\"select select-bordered select-primary\" id=\"aiTuningProfileSelect\">\n                                    <option value=\"0\">#0</option>\n                                    <option value=\"1\">#1</option>\n                                    <option value=\"2\">#2</option>\n                                    <option value=\"3\">#3</option>\n                                    <option value=\"4\">#4</option>\n                                    <option value=\"5\">#5</option>\n                                    <option value=\"6\">#6</option>\n                                    <option value=\"7\">#7</option>\n                                </select>\n                            </div>\n\n                            <div class=\"grid grid-cols-1 gap-1\">\n                                <span class=\"label-text\">Tuning Mode</span>\n                                <select class=\"select select-bordered\" id=\"aiTuningModeSelect\">\n                                    <option value=\"0\">Quick</option>\n                                    <option value=\"1\">Fine</option>\n                                </select>\n                            </div>\n\n                            <div class=\"divider\">Thresholds</div>\n\n                            <div class=\"grid grid-cols-2 gap-2\">\n                                <div class=\"grid grid-cols-1 gap-1\">\n                                    <span class=\"label-text\">Coarse Stop Threshold</span>\n                                    <input type=\"number\" class=\"input input-bordered input-sm\" id=\"aiCoarseThreshold\" step=\"0.001\">\n                                </div>\n                                <div class=\"grid grid-cols-1 gap-1\">\n                                    <span class=\"label-text\">Fine Stop Threshold</span>\n                                    <input type=\"number\" class=\"input input-bordered input-sm\" id=\"aiFineThreshold\" step=\"0.001\">\n                                </div>\n                            </div>\n\n                            <div class=\"grid grid-cols-2 gap-2\">\n                                <div class=\"grid grid-cols-1 gap-1\">\n                                    <span class=\"label-text\">Coarse Time Target (ms)</span>\n                                    <input type=\"number\" class=\"input input-bordered input-sm\" id=\"aiCoarseTimeTarget\" step=\"1\">\n                                </div>\n                                <div class=\"grid grid-cols-1 gap-1\">\n                                    <span class=\"label-text\">Total Time Target (ms)</span>\n                                    <input type=\"number\" class=\"input input-bordered input-sm\" id=\"aiTotalTimeTarget\" step=\"1\">\n                                </div>\n                            </div>\n\n                            <button class=\"btn btn-sm btn-neutral\" onclick=\"saveAiTuningThresholds()\">Save Thresholds</button>\n\n                            <div class=\"divider\">Tuning Status</div>\n\n                            <!-- Status Display -->\n                            <div id=\"aiTuningStatusSection\" class=\"grid grid-cols-1 gap-2\">\n                                <div class=\"flex justify-between\">\n                                    <span class=\"label-text\">Status:</span>\n                                    <span id=\"aiTuningState\" class=\"badge badge-neutral\">Idle</span>\n                                </div>\n                                <div class=\"flex justify-between\">\n                                    <span class=\"label-text\">Progress:</span>\n                                    <span id=\"aiTuningProgress\">0%</span>\n                                </div>\n                                <progress id=\"aiTuningProgressBar\" class=\"progress progress-primary w-full\" value=\"0\" max=\"100\"></progress>\n                                <div class=\"flex justify-between\">\n                                    <span class=\"label-text\">Drops:</span>\n                                    <span id=\"aiTuningDrops\">0 / 0</span>\n                                </div>\n                            </div>\n\n                            <!-- Current Parameters (shown during tuning) -->\n                            <div id=\"aiTuningCurrentParams\" class=\"grid grid-cols-1 gap-2\" style=\"display: none;\">\n                                <div class=\"divider\">Current Test Parameters</div>\n                                <div class=\"grid grid-cols-2 gap-2\">\n                                    <div class=\"stat bg-base-200 rounded-box p-2\">\n                                        <div class=\"stat-title text-xs\">Coarse Kp</div>\n                                        <div id=\"aiCurrentCoarseKp\" class=\"stat-value text-lg\">-</div>\n                                    </div>\n                                    <div class=\"stat bg-base-200 rounded-box p-2\">\n                                        <div class=\"stat-title text-xs\">Coarse Kd</div>\n                                        <div id=\"aiCurrentCoarseKd\" class=\"stat-value text-lg\">-</div>\n                                    </div>\n                                    <div class=\"stat bg-base-200 rounded-box p-2\">\n                                        <div class=\"stat-title text-xs\">Fine Kp</div>\n                                        <div id=\"aiCurrentFineKp\" class=\"stat-value text-lg\">-</div>\n                                    </div>\n                                    <div class=\"stat bg-base-200 rounded-box p-2\">\n                                        <div class=\"stat-title text-xs\">Fine Kd</div>\n                                        <div id=\"aiCurrentFineKd\" class=\"stat-value text-lg\">-</div>\n                                    </div>\n                                </div>\n                            </div>\n\n                            <!-- Recommended Parameters (shown when complete) -->\n                            <div id=\"aiTuningRecommendedParams\" class=\"grid grid-cols-1 gap-2\" style=\"display: none;\">\n                                <div class=\"divider\">Recommended Parameters</div>\n                                <div class=\"grid grid-cols-2 gap-2\">\n                                    <div class=\"stat bg-success/20 rounded-box p-2\">\n                                        <div class=\"stat-title text-xs\">Coarse Kp</div>\n                                        <div id=\"aiRecCoarseKp\" class=\"stat-value text-lg\">-</div>\n                                    </div>\n                                    <div class=\"stat bg-success/20 rounded-box p-2\">\n                                        <div class=\"stat-title text-xs\">Coarse Kd</div>\n                                        <div id=\"aiRecCoarseKd\" class=\"stat-value text-lg\">-</div>\n                                    </div>\n                                    <div class=\"stat bg-success/20 rounded-box p-2\">\n                                        <div class=\"stat-title text-xs\">Fine Kp</div>\n                                        <div id=\"aiRecFineKp\" class=\"stat-value text-lg\">-</div>\n                                    </div>\n                                    <div class=\"stat bg-success/20 rounded-box p-2\">\n                                        <div class=\"stat-title text-xs\">Fine Kd</div>\n                                        <div id=\"aiRecFineKd\" class=\"stat-value text-lg\">-</div>\n                                    </div>\n                                </div>\n                                <div class=\"grid grid-cols-3 gap-2 text-center text-sm\">\n                                    <div>\n                                        <div class=\"text-gray-500\">Avg Overthrow</div>\n                                        <div id=\"aiStatOverthrow\">-</div>\n                                    </div>\n                                    <div>\n                                        <div class=\"text-gray-500\">Avg Time</div>\n                                        <div id=\"aiStatTime\">-</div>\n                                    </div>\n                                    <div>\n                                        <div class=\"text-gray-500\">Consistency</div>\n                                        <div id=\"aiStatConsistency\">-</div>\n                                    </div>\n                                </div>\n                            </div>\n\n                            <div class=\"divider\"></div>\n\n                            <!-- Control Buttons -->\n                            <div class=\"grid grid-cols-2 gap-2\">\n                                <button id=\"aiTuningStartBtn\" class=\"btn btn-primary\" onclick=\"startAiTuning()\">Start Tuning</button>\n                                <button id=\"aiTuningCancelBtn\" class=\"btn btn-warning\" onclick=\"cancelAiTuning()\" disabled>Cancel</button>\n                            </div>\n                            <button id=\"aiTuningApplyBtn\" class=\"btn btn-success w-full\" onclick=\"applyAiTuning()\" disabled>Apply Recommended Parameters</button>\n\n                            <div class=\"divider\">ML Learning (Last 10 Drops)</div>\n\n                            <!-- ML Drop History -->\n                            <div id=\"aiTuningHistorySection\" class=\"grid grid-cols-1 gap-2\">\n                                <div class=\"flex justify-between items-center\">\n                                    <span id=\"aiHistoryCount\" class=\"badge badge-info\">0 drops</span>\n                                    <button class=\"btn btn-xs btn-ghost\" onclick=\"clearAiTuningHistory()\">Clear</button>\n                                </div>\n\n                                <!-- Suggested Refinements -->\n                                <div id=\"aiSuggestedSection\" style=\"display: none;\">\n                                    <div class=\"alert alert-success\">\n                                        <span class=\"font-bold\">Suggested Refinements:</span>\n                                        <div class=\"grid grid-cols-2 gap-2 w-full mt-2\">\n                                            <div>Coarse: <span id=\"aiSugCoarseKp\">-</span> / <span id=\"aiSugCoarseKd\">-</span></div>\n                                            <div>Fine: <span id=\"aiSugFineKp\">-</span> / <span id=\"aiSugFineKd\">-</span></div>\n                                        </div>\n                                    </div>\n                                    <button class=\"btn btn-sm btn-success w-full mt-2\" onclick=\"applyRefinedParams()\">Apply Refined Values</button>\n                                </div>\n\n                                <!-- Drop History Table -->\n                                <div id=\"aiHistoryList\" class=\"overflow-x-auto\">\n                                    <table class=\"table table-xs\">\n                                        <thead>\n                                            <tr>\n                                                <th>#</th>\n                                                <th>Profile</th>\n                                                <th>Overthrow</th>\n                                                <th>Time</th>\n                                            </tr>\n                                        </thead>\n                                        <tbody id=\"aiHistoryTableBody\">\n                                        </tbody>\n                                    </table>\n                                </div>\n                            </div>\n                        </div>\n                    </section>\n\n                </div>\n            </div>\n            <div class=\"drawer-side exclude-bottom-nav\">\n                <label id=\"closeDrawerSide\" for=\"settingsDrawer\" aria-label=\"close sidebar\" class=\"drawer-overlay\"></label>\n                <ul id=\"drawerSlide\" class=\"menu menu-vertical p-2 w-60 bg-base-200 pb-20\">\n                    <!-- Sidebar content here -->\n                    <li><a class=\"text-lg\" onclick=\"onSettingsLinkClicked(\'settings-scale\')\">Scale</a></li>\n                    <li><a class=\"text-lg\" onclick=\"onSettingsLinkClicked(\'settings-profile\')\">Profiles</a></li>\n                    <li><a class=\"text-lg\" onclick=\"onSettingsLinkClicked(\'settings-charge-mode\')\">Charge Mode</a></li>\n                    <li><a class=\"text-lg\" onclick=\"onSettingsLinkClicked(\'settings-ai-tuning\')\">PID Auto-Tuning</a></li>\n                    <li><a class=\"text-lg\" onclick=\"onSettingsLinkClicked(\'settings-wifi\')\">WiFi</a></li>\n                    <li><a class=\"text-lg\" onclick=\"onSettingsLinkClicked(\'settings-coarse-motor\')\">Coarse Motor</a></li>\n                    <li><a class=\"text-lg\" onclick=\"onSettingsLinkClicked(\'settings-fine-motor\')\">Fine Motor</a></li>\n                    <li><a class=\"text-lg\" onclick=\"onSettingsLinkClicked(\'settings-motors\')\">Motors</a></li>\n                    <li><a class=\"text-lg\" onclick=\"onSettingsLinkClicked(\'settings-neopixel-led\')\">Neopixel LED</a></li>\n                    <li><a class=\"text-lg\" onclick=\"onSettingsLinkClicked(\'settings-display\')\">Display</a></li>\n                    <li><a class=\"text-lg\" onclick=\"onSettingsLinkClicked(\'settings-mini-12864-module\')\">Mini 12864 Module</a></li>\n                    <li><a class=\"text-lg\" onclick=\"onSettingsLinkClicked(\'settings-servo-gate\')\">Servo Gate</a></li>\n                    <li><a class=\"text-lg\" onclick=\"onSettingsLinkClicked(\'settings-system-control\')\">System Control</a></li>\n                    <li><a class=\"text-lg\" onclick=\"onSettingsLinkClicked(\'settings-errors\')\">Errors</a></li>\n                </ul>\n            </div>\n        </div>\n\n    </section>\n</div>\n\n\n<!-- Bottom navigation bar -->\n<div class=\"btm-nav\">\n    <button id=\"tricklerNavButton\" class=\"active\" onclick=\"onNavButtonClicked(\'trickler\')\">\n        <svg class=\"w-6 h-6 text-gray-800 dark:text-white\" aria-hidden=\"true\" xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" fill=\"none\" viewBox=\"0 0 24 24\">\n            <path stroke=\"currentColor\" stroke-linecap=\"round\" stroke-width=\"2\" d=\"M18.796 4H5.204a1 1 0 0 0-.753 1.659l5.302 6.058a1 1 0 0 1 .247.659v4.874a.5.5 0 0 0 .2.4l3 2.25a.5.5 0 0 0 .8-.4v-7.124a1 1 0 0 1 .247-.659l5.302-6.059c.566-.646.106-1.658-.753-1.658Z\"/>\n          </svg>          \n        <span class=\"text-sm text-gray-500 dark:text-gray-400 group-hover:text-blue-600 dark:group-hover:text-blue-500\">Trickler</span>\n    </button>\n    <button id=\"settingsNavButton\" onclick=\"onNavButtonClicked(\'settings\')\">\n        <svg class=\"w-5 h-5 mb-2 text-gray-500 dark:text-gray-400 group-hover:text-blue-600 dark:group-hover:text-blue-500\" aria-hidden=\"true\" xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 20 20\">\n            <path stroke=\"currentColor\" stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M4 12.25V1m0 11.25a2.25 2.25 0 0 0 0 4.5m0-4.5a2.25 2.25 0 0 1 0 4.5M4 19v-2.25m6-13.5V1m0 2.25a2.25 2.25 0 0 0 0 4.5m0-4.5a2.25 2.25 0 0 1 0 4.5M10 19V7.75m6 4.5V1m0 11.25a2.25 2.25 0 1 0 0 4.5 2.25 2.25 0 0 0 0-4.5ZM16 19v-2\"/>\n        </svg>\n        <span class=\"text-sm text-gray-500 dark:text-gray-400 group-hover:text-blue-600 dark:group-hover:text-blue-500\">Settings</span>\n    </button>\n    <button id=\"purgeNavButton\" onclick=\"onNavButtonClicked(\'purge\')\">\n        <svg class=\"w-6 h-6 text-gray-800 dark:text-white\" aria-hidden=\"true\" xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" fill=\"none\" viewBox=\"0 0 24 24\">\n            <path stroke=\"currentColor\" stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M16 12H4m12 0-4 4m4-4-4-4m3-4h2a3 3 0 0 1 3 3v10a3 3 0 0 1-3 3h-2\"/>\n          </svg>          \n        <span class=\"text-sm text-gray-500 dark:text-gray-400 group-hover:text-blue-600 dark:group-hover:text-blue-500\">Purge</span>\n    </button>\n</div>\n\n\n<!-- Other resources -->\n<dialog id=\"applySystemControlDialog\" class=\"modal modal-bottom sm:modal-middle\">\n    <div class=\"modal-box\">\n        <div class=\"grid grid-cols-1 gap-2\">\n            <h3 class=\"font-bold text-lg\">Pending Actions</h3>\n            <div id=\"systemControlDialogWarningText\"></div>\n        </div>\n        <div class=\"modal-action\">\n            <form method=\"dialog\">\n                <!-- if there is a button in form, it will close the modal -->\n                <div class=\"grid grid-cols-2 gap-2\">\n                    <button id=\"dialogSystemControlApplySettingsButton\" class=\"btn btn-error\">Apply</button>\n                    <button class=\"btn\">Cancel</button>\n                </div>\n            </form>\n        </div>\n    </div>\n</dialog>\n\n\n<dialog id=\"applySettingsDialog\" class=\"modal modal-bottom sm:modal-middle\">\n    <div class=\"modal-box\">\n        <div class=\"grid grid-cols-1 gap-2\">\n            <h3 class=\"font-bold text-lg\">\n                Save <span id=\"applySettingsDialogTitle\"></span> Settings\n            </h3>\n            <p class=\"py-4\">Do you also want to save settings to EEPROM?</p>\n        </div>\n        <div class=\"modal-action\">\n            <form method=\"dialog\">\n                <!-- if there is a button in form, it will close the modal -->\n                <div class=\"grid grid-cols-3 gap-2\">\n                    <button id=\"dialogSaveToEepromButton\" class=\"btn btn-primary\">Save to EEPROM</button>\n                    <button id=\"dialogApplySettingsButton\" class=\"btn btn-neutral\">Apply</button>\n                    <button class=\"btn\">Cancel</button>\n                </div>\n            </form>\n        </div>\n    </div>\n</dialog>\n\n<dialog id=\"quickChangeProfileDialog\" class=\"modal modal-bottom sm:modal-middle\">\n    <div class=\"modal-box\">\n        <div class=\"grid grid-cols-1 gap-2\">\n            <h3 class=\"font-bold text-lg\">Change Profile</h3>\n            <select id=\"quickChangeProfileSelect\" class=\"select select-bordered w-full max-w-xs\">\n            </select>\n        </div>\n        <div class=\"modal-action\">\n            <form method=\"dialog\">\n                <!-- if there is a button in form, it will close the modal -->\n                <button id=\"quickChangeProfileConfirmButton\" class=\"btn\" onclick=\"onQuickProfileSelectConfirmed()\">Confirm</button>\n            </form>\n        </div>\n    </div>\n</dialog>\n\n<dialog id=\"invalidChargeWeightDialog\" class=\"modal\">\n    <div class=\"modal-box\">\n        <h3 class=\"font-bold text-lg\">Error</h3>\n        <p class=\"py-4\">Invalid charge weight</p>\n    </div>\n    <form method=\"dialog\" class=\"modal-backdrop\">\n        <button>close</button>\n    </form>\n</dialog>\n\n<dialog id=\"overThrowDialog\" class=\"modal\">\n    <div class=\"modal-box\">\n        <h3 class=\"font-bold text-lg\">Warning</h3>\n        <p class=\"py-4\">Over Throw!</p>\n    </div>\n    <form method=\"dialog\" class=\"modal-backdrop\">\n        <button>close</button>\n    </form>\n</dialog>\n\n<dialog id=\"underThrowDialog\" class=\"modal\">\n    <div class=\"modal-box\">\n        <h3 class=\"font-bold text-lg\">Warning</h3>\n        <p class=\"py-4\">Under Throw!</p>\n    </div>\n    <form method=\"dialog\" class=\"modal-backdrop\">\n        <button>close</button>\n    </form>\n</dialog>\n\n<dialog id=\"settingsAppliedSuccessDialog\" class=\"modal\">\n    <div class=\"modal-box\" id=\"settingsAppliedSuccessText\">\n        <h3 class=\"font-bold text-lg\">Info</h3>\n        <p class=\"py-4\">Settings Applied</p>\n    </div>\n    <form method=\"dialog\" class=\"modal-backdrop\">\n        <button>close</button>\n    </form>\n</dialog>\n\n<dialog id=\"settingsRestoreFailedDialog\" class=\"modal\">\n    <div class=\"modal-box\" id=\"settingsRestoreFailedText\">\n    </div>\n    <form method=\"dialog\" class=\"modal-backdrop\">\n        <button>close</button>\n    </form>\n</dialog>\n\n<dialog id=\"scaleZeroedSuccessDialog\" class=\"modal\">\n    <div class=\"modal-box\">\n        <h3 class=\"font-bold text-lg\">Info</h3>\n        <p class=\"py-4\">Scale Zero Successful</p>\n    </div>\n    <form method=\"dialog\" class=\"modal-backdrop\">\n        <button>close</button>\n    </form>\n</dialog>\n\n<dialog id=\"scaleZeroedFailDialog\" class=\"modal\">\n    <div class=\"modal-box\">\n        <h3 class=\"font-bold text-lg\">Error</h3>\n        <p class=\"py-4\">Failed to Zero Scale</p>\n    </div>\n    <form method=\"dialog\" class=\"modal-backdrop\">\n        <button>close</button>\n    </form>\n</dialog>\n\n<!-- Scripts to support the webapp -->\n<script>\n    const ChargeModeState = Object.freeze({ \n        EXIT: 0,\n        WAIT: 1, \n        CHARGING: 2, \n        REMOVE_CUP: 3, \n        RETURN_CUP: 4, \n    }); \n\n    const ChargeModeEvent = Object.freeze({ \n        NO_EVENT: 1 << 0, \n        UNDER_CHARGE: 1 << 1, \n        OVER_CHARGE: 1 << 2, \n    });\n\n    const ScaleAction = Object.freeze({ \n        NO_ACTION: 0,\n        FORCE_ZERO: 1,\n    });\n\n    const CleanupModeState = Object.freeze({\n        EXIT: 0,\n        ENTER: 1,\n    });\n\n    const ServoGateState = Object.freeze({\n        GATE_DISABLED: 0,\n        GATE_CLOSE: 1,\n        GATE_OPEN: 2,\n    });\n\n    var pollSetTimeoutId;\n\n    // Set Charge Mode Set Point with REST interface\n    function setChargeWeight() {\n        // Read charge weight\n        const chargeWeight = document.getElementById(\"chargeWeightInput\").value;\n\n        // If the charge weight is empty\n        if (chargeWeight == \"\") {\n            const errorModal = document.getElementById(\'invalidChargeWeightDialog\');\n            errorModal.showModal();\n\n            return;\n        }\n\n        // Build URI\n        const uri = `/rest/charge_mode_state?s0=${encodeURIComponent(chargeWeight)}&s2=${encodeURIComponent(ChargeModeState.WAIT)}`;\n\n        // Call set charge weight REST\n        fetch(uri)\n        .then(response => {\n            _restartPoll();  // Start the poll immediately to update the charge status\n        })\n        .catch(error => {\n            console.error(\"Error setting charge weight\");\n        });\n    }\n\n    function enterChargeMode(enter) {\n        var charge_mode_status_value = null;\n        if (enter) {\n            charge_mode_status_value = ChargeModeState.WAIT;\n        }\n        else {\n            charge_mode_status_value = ChargeModeState.EXIT;\n        }\n\n        // Build URI\n        const uri = `/rest/charge_mode_state?s2=${encodeURIComponent(charge_mode_status_value)}`;\n\n        // Call set charge weight REST\n        fetch(uri)\n        .then(response => {\n            _restartPoll();  // Start the poll immediately to update the charge status\n        })\n        .catch(error => {\n            console.error(\"Error setting charge mode status\");\n        });\n    }\n\n    // Helper function to update progress widget\n    const PRIMARY_CLASS = \"step-primary\";\n\n    function _setChargeModeStateWidget(state) {\n        const chargeModeStateWait = document.getElementById(\"chargeModeStateWait\");\n        const chargeModeStateCharging = document.getElementById(\"chargeModeStateCharging\");\n        const chargeModeStateRemoveCup = document.getElementById(\"chargeModeStateRemoveCup\");\n        const chargeModeStateReturnCup = document.getElementById(\"chargeModeStateReturnCup\");\n\n        switch (state) {\n            case ChargeModeState.WAIT:\n                chargeModeStateWait.classList.add(PRIMARY_CLASS);\n                chargeModeStateCharging.classList.remove(PRIMARY_CLASS)\n                chargeModeStateRemoveCup.classList.remove(PRIMARY_CLASS)\n                chargeModeStateReturnCup.classList.remove(PRIMARY_CLASS)\n                break;\n            case ChargeModeState.CHARGING:\n                chargeModeStateWait.classList.add(PRIMARY_CLASS);\n                chargeModeStateCharging.classList.add(PRIMARY_CLASS)\n                chargeModeStateRemoveCup.classList.remove(PRIMARY_CLASS)\n                chargeModeStateReturnCup.classList.remove(PRIMARY_CLASS)\n                break;\n            case ChargeModeState.REMOVE_CUP:\n                chargeModeStateWait.classList.add(PRIMARY_CLASS);\n                chargeModeStateCharging.classList.add(PRIMARY_CLASS)\n                chargeModeStateRemoveCup.classList.add(PRIMARY_CLASS)\n                chargeModeStateReturnCup.classList.remove(PRIMARY_CLASS)\n                break;\n            case ChargeModeState.RETURN_CUP:\n                chargeModeStateWait.classList.add(PRIMARY_CLASS);\n                chargeModeStateCharging.classList.add(PRIMARY_CLASS)\n                chargeModeStateRemoveCup.classList.add(PRIMARY_CLASS)\n                chargeModeStateReturnCup.classList.add(PRIMARY_CLASS)\n                break;\n            case ChargeModeState.EXIT:\n                chargeModeStateWait.classList.remove(PRIMARY_CLASS);\n                chargeModeStateCharging.classList.remove(PRIMARY_CLASS)\n                chargeModeStateRemoveCup.classList.remove(PRIMARY_CLASS)\n                chargeModeStateReturnCup.classList.remove(PRIMARY_CLASS)\n                break;\n        }\n    }\n    \n    // Helper function to set the current weight widget\n    function _setCurrentWeight(weight, percentage) {\n        var currentWeightDecimal = document.getElementById(\"currentWeightDecimal\");\n        currentWeightDecimal.innerText = String(weight);\n\n        var currentWeightProgressPencentage = document.getElementById(\"currentWeightProgressPencentage\");\n        currentWeightProgressPencentage.value = percentage;\n    }\n\n    function _setStartStopButtonWidget(isStart) {\n        const confirmButton = document.getElementById(\"confirmButton\");\n        const stopButton = document.getElementById(\"stopButton\");\n\n        if (isStart) {\n            confirmButton.disabled = true;\n            stopButton.disabled = false;\n        }\n        else {\n            stopButton.disabled = true;\n            confirmButton.disabled = false;\n        }\n    }\n\n    function onProfileNameClicked() {\n        const quickChangeProfileDialog = document.getElementById(\"quickChangeProfileDialog\");\n        const quickChangeProfileSelect = document.getElementById(\"quickChangeProfileSelect\");\n\n        // Populate the dialog option and show the modal\n        fetch(\"/rest/profile_summary\")\n        .then(response => {\n            return response.json();\n        })\n        .then(data => {\n            const all_profiles = data[\"s0\"];\n            const current_profile_idx = data[\"s1\"];\n            // First remove existing options\n            var length = quickChangeProfileSelect.options.length;\n            for(var i = 0; i < length; i += 1) {\n                quickChangeProfileSelect.remove(i);     \n            }\n            quickChangeProfileSelect.options.length = 0;\n\n            // Then populate according to the new list\n            for (const idx in all_profiles) {\n                var option = document.createElement(\"option\");\n                option.value = idx;\n                option.innerText = all_profiles[idx];\n                quickChangeProfileSelect.appendChild(option);\n            }\n            // Select the current\n            quickChangeProfileSelect.value = current_profile_idx;\n            \n            // Show the modal\n            quickChangeProfileDialog.showModal();\n        })\n        .catch(error => {\n            console.error(\"Error reading profile summary\");\n        })\n    }\n\n    function onQuickProfileSelectConfirmed() {\n        const quickChangeProfileSelect = document.getElementById(\"quickChangeProfileSelect\");\n\n        const uri = `/rest/profile_config?pf=${encodeURIComponent(quickChangeProfileSelect.value)}`;\n\n        fetch(uri)\n        .then(response => {\n            return response.json();\n        })\n        .catch(error => {\n            console.error(\"Error setting profile\");\n        })\n    }\n\n    // Function to poll charge mode status (weight, progress, etc)\n    function pollChargeModeStatus() {\n        fetch(\"/rest/charge_mode_state\")\n        .then(response => {\n            return response.json()\n        })\n        .then(data => {\n            // console.log(data);\n            // Parse data\n            const charge_weight_set_point = data[\"s0\"];\n            const current_charge_weight = data[\"s1\"];\n            const charge_mode_state = data[\"s2\"];\n            const charge_mode_event = data[\"s3\"];\n            const profile_name = data[\"s4\"];\n            const charge_time_seconds = data[\"s5\"] || \"-.--\";\n\n            var percentage = 0;\n            if (charge_weight_set_point == 0) {\n                percentage = 0;\n            }\n            else {\n                percentage = current_charge_weight / charge_weight_set_point * 100.0;\n            }\n\n            // Update web element\n            _setCurrentWeight(current_charge_weight, percentage);\n            _setChargeModeStateWidget(charge_mode_state);\n\n            profileName = document.getElementById(\"profileName\");\n            profileName.innerText = String(profile_name);\n            \n            // Find the charge time element and update its text content\n            const chargeTimeElement = document.getElementById(\'chargeTimeValue\');\n            if (chargeTimeElement) {\n                chargeTimeElement.textContent = `${charge_time_seconds} s`;\n            }\n\n            if (charge_mode_state == ChargeModeState.EXIT) {\n                _setStartStopButtonWidget(false);\n            }\n            else {\n                _setStartStopButtonWidget(true);\n            }\n\n            // Process event\n            if (charge_mode_event != ChargeModeEvent.NO_EVENT) {\n                var dialog_name = null;\n                if (charge_mode_event == ChargeModeEvent.UNDER_CHARGE) {\n                    dialog_name = \"underThrowDialog\";\n                }\n                else if (charge_mode_event == ChargeModeEvent.OVER_CHARGE) {\n                    dialog_name = \"overThrowDialog\";\n                }\n\n                // Show modal\n                const dialogModal = document.getElementById(dialog_name);\n                if (dialogModal) {\n                    dialogModal.showModal();\n                }\n            }\n        })\n        .catch(error => {\n            console.error(\"Error reading charge mode settings\");\n            _setCurrentWeight(\"---\", 0);\n            _setChargeModeStateWidget(ChargeModeState.WAIT);\n        })\n        .finally(() => {\n            // Schedule the next event\n            clearTimeout(pollSetTimeoutId);\n            pollSetTimeoutId = setTimeout(pollChargeModeStatus, 500);\n        })\n    }\n\n    // Send scale force zero command\n    function scaleForceZero() {\n        const uri = `/rest/scale_action?a0=${encodeURIComponent(ScaleAction.FORCE_ZERO)}`;\n\n        // Call the scale action URI\n        fetch(uri)\n        .then(response => {\n            return response.json();\n        })\n        .then(data => {\n            // console.log(data);\n\n            var scale_action_response = data[\"a0\"];\n\n            if (scale_action_response == ScaleAction.FORCE_ZERO) {\n                const dialogModal = document.getElementById(\"scaleZeroedSuccessDialog\");\n                dialogModal.showModal();\n            }\n            else {\n                const dialogModal = document.getElementById(\"scaleZeroedFailDialog\");\n                dialogModal.showModal();\n        }\n        })\n        .catch(error => {\n            console.error(\"Error applying force zero\");\n        });\n    }\n\n    function servoGateSetState(state) {\n        const uri = `/rest/servo_gate_state?g0=${encodeURIComponent(state)}`;\n\n        // Call the scale action URI\n        fetch(uri)\n        .then(response => {\n            return response.json();\n        })\n        .then(data => {\n            // console.log(data);\n        })\n        .catch(error => {\n            console.error(\"Error applying servo gate state\");\n        });\n    }\n\n    function setPicoLed(on) {\n        fetch(\'/rest/pico_led?state=\' + (on ? \'1\' : \'0\')).catch(() => {});\n    }\n\n    // Switch pages\n    function onNavButtonClicked(button) {\n        const sectionTrickler = document.getElementById(\"sectionTrickler\");\n        const sectionTricklerChargeMode = document.getElementById(\"sectionTricklerChargeMode\");\n        const sectionTricklerCleanUpMode = document.getElementById(\"sectionTricklerCleanUpMode\");\n\n        const sectionSettings = document.getElementById(\"sectionSettings\");\n\n        const settingsNavButton = document.getElementById(\"settingsNavButton\")\n        const purgeNavButton = document.getElementById(\"purgeNavButton\");\n        const tricklerNavButton = document.getElementById(\"tricklerNavButton\");\n\n        switch (button) {\n            case \"trickler\":\n                enterCleanUpMode(false);\n\n                // Section control\n                sectionSettings.style.display = \"none\";\n                sectionTrickler.style.display = \"block\";\n                sectionTricklerChargeMode.style.display = \"block\";\n                sectionTricklerCleanUpMode.style.display = \"none\";\n\n                // Button active control\n                settingsNavButton.classList.remove(\"active\");\n                purgeNavButton.classList.remove(\"active\");\n                tricklerNavButton.classList.add(\"active\");\n\n                // Restart\n                _restartPoll();\n                break;\n            case \"purge\":\n                sectionSettings.style.display = \"none\";\n                sectionTrickler.style.display = \"block\";\n                sectionTricklerChargeMode.style.display = \"none\";\n                sectionTricklerCleanUpMode.style.display = \"block\";\n\n                // Button active control\n                settingsNavButton.classList.remove(\"active\");\n                tricklerNavButton.classList.remove(\"active\");\n                purgeNavButton.classList.add(\"active\");\n                \n                // Restart\n                _restartPoll();\n\n                // Exit Charge mode\n                enterChargeMode(false);\n\n                // Enter clean up mode\n                enterCleanUpMode(true);\n                break;\n            case \"settings\":\n                sectionTrickler.style.display = \"none\";\n                sectionSettings.style.display = \"block\";\n\n                // Button active control\n                tricklerNavButton.classList.remove(\"active\");\n                purgeNavButton.classList.remove(\"active\");\n                settingsNavButton.classList.add(\"active\");\n\n                // Remove polling event\n                clearTimeout(pollSetTimeoutId);\n\n                // Load the first settings\n                onSettingsLinkClicked(\"settings-scale\");\n                \n                break;\n            default:\n                break;\n        }\n    }\n\n    // Helper function to restart the poll immediately\n    function _restartPoll() {\n        clearTimeout(pollSetTimeoutId);\n        pollSetTimeoutId = setTimeout(pollChargeModeStatus, 0);\n    }\n\n    // Functions show settings page\n    function onSettingsLinkClicked(sectionId) {\n        const targetSection = document.getElementById(sectionId);\n        const settingsSectionTitle = document.getElementById(\"settingsSectionTitle\");\n\n        // Enumerate all sections to set hide/display\n        const sections = document.querySelectorAll(\'.settings-page\');\n\n        // Set visibility\n        for (const section of sections) {\n            if (section.id == targetSection.id) {\n                section.style.display = \"block\";\n                settingsSectionTitle.innerText = targetSection.getAttribute(\"name\");\n            }\n            else {\n                section.style.display = \"none\";\n            }\n        }\n        \n        // Close the drawer\n        const settingsDrawer = document.getElementById(\"settingsDrawer\");\n        if (settingsDrawer.checked) {\n            settingsDrawer.checked = false;\n        }\n\n        // Populate values\n        const form = targetSection.querySelector(\"form\");\n        if (form) {\n            const uri = form.getAttribute(\"action\");\n            fetch(uri)\n            .then(response => {\n                return response.json();\n            })\n            .then(data => {\n                // Populate the form\n                for (const key in data) {\n                    const element = form.querySelector(\'[name=\"\' + key + \'\"]\');\n                    if (element) {\n                        element.value = String(data[key]);\n                    }\n                }\n            })\n        }\n\n        \n        // Special handling for motors section\n        if (sectionId === \"settings-motors\") {\n            loadMotorsState();\n        }\n\n        // Special handling for display section\n        if (sectionId === \"settings-display\") {\n            setTimeout(() => {\n                onDisplayTypeChanged();\n                updateBrightnessLabel();\n            }, 100);\n        }\n\n        // Special handling for errors section\n        if (sectionId === \"settings-errors\") {\n            refreshErrors();\n        }\n\n        // Special handling for profile section\n        if (sectionId === \"settings-profile\") {\n            loadProfileDropdowns();\n        }\n\n        // Special handling for AI tuning section\n        if (sectionId === \"settings-ai-tuning\") {\n            loadAiTuningProfiles();\n            loadAiTuningThresholds();\n            loadAiTuningHistory();\n            // Check current status in case tuning is already running\n            fetch(\"/rest/ai_tuning_status\")\n            .then(response => response.json())\n            .then(data => {\n                updateAiTuningUI(data);\n                if (data.is_active) {\n                    document.getElementById(\"aiTuningStartBtn\").disabled = true;\n                    document.getElementById(\"aiTuningCancelBtn\").disabled = false;\n                    document.getElementById(\"aiTuningProfileSelect\").disabled = true;\n                    document.getElementById(\"aiTuningModeSelect\").disabled = true;\n                    pollAiTuningStatus();\n                }\n            })\n            .catch(error => {\n                console.error(\"Error checking AI tuning status:\", error);\n            });\n        }\n    }\n\n    // Function to retrieve the profile values when the index is updated\n    function populateProfileSelection(select) {\n        const profileIdx = select.value;\n        const form = select.form;\n\n        const uri = form.getAttribute(\"action\") + `?pf=${encodeURIComponent(profileIdx)}`\n        fetch(uri)\n        .then(response => {\n            return response.json();\n        })\n        .then(data => {\n            // Populate the form\n            for (const key in data) {\n                const element = form.querySelector(\'[name=\"\' + key + \'\"]\');\n                if (element) {\n                    element.value = String(data[key]);\n                }\n            }\n        })\n    }\n\n    // Submit the form data to the action URI\n    function putForm(targetForm, savePersistent) {\n        const paramData = new FormData(targetForm);\n\n        // Remove empty param\n        for (const [key, value] of paramData.entries()) {\n            if (value == \"\") {\n                paramData.delete(key);\n            }\n        }\n\n        if (savePersistent) {\n            // WiFi config saves to flash, others save to EEPROM\n            if (targetForm.action.includes(\'wireless_config\')) {\n                paramData.append(\'save\', true)\n            } else {\n                paramData.append(\'ee\', true)\n            }\n        }\n\n        const queryString = new URLSearchParams(paramData).toString();\n        const uri = new URL(targetForm.action + \'?\');\n        uri.search = queryString;\n\n        // Post the new param with GET method\n        fetch(uri)\n        .then(response => {\n            return response.json();\n        })\n        .then(data => {\n            // Populate values\n            const uri = targetForm.getAttribute(\"action\");\n            fetch(uri)\n            .then(response => {\n                return response.json();\n            })\n            .then(data => {\n                // Populate the form\n                for (const key in data) {\n                    const element = targetForm.querySelector(\'[name=\"\' + key + \'\"]\');\n                    if (element) {\n                        element.value = String(data[key]);\n                    }\n                }\n            })\n\n            // Refresh profile dropdowns if profile was saved (name may have changed)\n            if (targetForm.action.includes(\'profile_config\')) {\n                loadProfileDropdowns();\n            }\n\n            // Show the success modal\n            const settingsAppliedSuccessDialog = document.getElementById(\"settingsAppliedSuccessDialog\");\n            settingsAppliedSuccessDialog.showModal();\n        })\n    }\n\n    // Function to populate the dialog when Apply button is pressed for settings\n    const allApplyButtons = document.querySelectorAll(\".settings-apply-btn\");\n    allApplyButtons.forEach(applyButton => {\n        applyButton.addEventListener(\"click\", (event) => {\n            event.preventDefault();  // Cancel default event\n\n            const form = applyButton.form;\n\n            // Create the dialog\n            const applySettingsDialog = document.getElementById(\"applySettingsDialog\");\n\n            // Update dialog title\n            applySettingsDialogTitle = document.getElementById(\"applySettingsDialogTitle\");\n            const sectioName = form.closest(\"section\").getAttribute(\"name\");\n            applySettingsDialogTitle.innerText = sectioName;\n\n            // Bind the button\n            const dialogApplySettingsButton = document.getElementById(\"dialogApplySettingsButton\");\n            const dialogSaveButton = document.getElementById(\"dialogSaveToEepromButton\");\n            const dialogText = applySettingsDialog.querySelector(\"p\");\n\n            // WiFi saves to flash, others save to EEPROM\n            const isWiFi = form.action.includes(\'wireless_config\');\n            dialogSaveButton.innerText = isWiFi ? \"Save to Flash\" : \"Save to EEPROM\";\n            dialogText.innerText = isWiFi ? \"Do you also want to save settings to flash?\" : \"Do you also want to save settings to EEPROM?\";\n\n            // Bind actions\n            dialogApplySettingsButton.onclick = function() {\n                putForm(form, false);\n            }\n\n            dialogSaveButton.onclick = function() {\n                putForm(form, true);\n            }\n\n            // Show the dialog\n            applySettingsDialog.showModal();\n        })\n    })\n\n    const allApplySystemControlButton = document.querySelectorAll(\".system-control-apply-btn\");\n    allApplySystemControlButton.forEach(applyButton => {\n        applyButton.addEventListener(\"click\", (event) => {\n            event.preventDefault();  // Cancel default event\n\n            const form = applyButton.form;\n\n            // Create the dialog\n            const applySettingsDialog = document.getElementById(\"applySystemControlDialog\");\n            const systemControlDialogWarningText = document.getElementById(\'systemControlDialogWarningText\');\n\n            // Update dialog content\n            var formData = new FormData(form);\n            let bodyText = \'<ul class=\"list-disc\">\';\n            if (formData.get(\"s4\") == \'true\') {\n                bodyText += \"<li>Save all settings to EEPROM</li>\";\n            }\n            if (formData.get(\"s5\") == \'true\') {\n                bodyText += \"<li>Reboot the OpenTrickler</li>\";\n            }\n            if (formData.get(\"s6\") == \'true\') {\n                bodyText += \"<li>Erase the EEPROM. You cannot undo this action!</li>\";\n            }\n            bodyText += \"</ul>\";\n\n            systemControlDialogWarningText.innerHTML = bodyText;\n\n\n            // Bind the button\n            const dialogApplySettingsButton = document.getElementById(\"dialogSystemControlApplySettingsButton\");\n\n            // Bind actions\n            dialogApplySettingsButton.onclick = function() {\n                putForm(form, false);\n            }\n\n            // Show the dialog\n            applySettingsDialog.showModal();\n        })\n    })\n\n    function debounce(callback, delay) {\n        let timer\n        return function() {\n            clearTimeout(timer)\n            timer = setTimeout(() => {\n                callback();\n            }, delay)\n        }\n    }\n\n    // Update the trickler move speed in cleanup mode based on the slider input\n    function onTricklerSpeedUpdate() {\n        const new_speed = document.getElementById(\"tricklerSpeedSlider\").value;\n        const uri = `/rest/cleanup_mode_state?s1=${encodeURIComponent(new_speed)}`;\n        fetch(uri);\n    }\n    const debouncedOnTricklerSpeedUpdate = debounce(onTricklerSpeedUpdate, 20);\n\n    function onStopCleanupButtonClicked() {\n        document.getElementById(\"tricklerSpeedSlider\").value = \"0\";\n        const uri = `/rest/cleanup_mode_state?s1=${encodeURIComponent(0)}`;\n        fetch(uri);\n    }\n\n    // Enter or exit the clean up mode\n    function enterCleanUpMode(enter) {\n        var cleanup_state_value = null;\n        if (enter) {\n            cleanup_state_value = CleanupModeState.ENTER;\n        }\n        else {\n            cleanup_state_value = CleanupModeState.EXIT;\n        }\n        const uri = `/rest/cleanup_mode_state?s0=${encodeURIComponent(cleanup_state_value)}`;\n        fetch(uri);\n    }\n\n    async function onExportProfileBtnClicked(event) {\n        // Skip the default response\n        event.preventDefault();\n\n        const config = {};\n\n        // Read metadata\n        let response = await fetch(\"/rest/system_control\");\n        const system_control_data = await response.json();\n        config[\"unique_id\"] = system_control_data[\"s0\"];\n        config[\"firmware_version\"] = system_control_data[\"s1\"];\n        config[\"vcs_hash\"] = system_control_data[\"s2\"];\n        config[\"config\"] = {};\n\n        // get current selected profile\n        const select_profile = document.getElementById(\"select_profile_option\");\n\n        // Fetch data from endpoints\n        const url_string = `/rest/profile_config?pf=${select_profile.value}`\n        response = await fetch(url_string);\n        const profile_data = await response.json();\n        config[\"config\"][url_string] = profile_data;\n\n        // download as a file\n        const blob = new Blob([JSON.stringify(config, null, \"\\t\")], {type: \'application/json\'});\n        const url = URL.createObjectURL(blob);\n        const a = document.createElement(\'a\');\n        a.href = url;\n        a.download = profile_data[\"p2\"] + \".json\"\n        a.click();\n        URL.revokeObjectURL(url);\n    }\n\n    async function onExportConfigClicked() {\n        const config = {};\n\n        const endpoints = [\n            \"/rest/scale_config\",\n            \"/rest/charge_mode_config\",\n            \"/rest/coarse_motor_config\",\n            \"/rest/fine_motor_config\",\n            \"/rest/mini_12864_config\",\n            \"/rest/wireless_config\",\n            \"/rest/neopixel_led_config\",\n            \"/rest/profile_config?pf=0\",\n            \"/rest/profile_config?pf=1\",\n            \"/rest/profile_config?pf=2\",\n            \"/rest/profile_config?pf=3\",\n            \"/rest/profile_config?pf=4\",\n            \"/rest/profile_config?pf=5\",\n            \"/rest/profile_config?pf=6\",\n            \"/rest/profile_config?pf=7\",\n            \"/rest/servo_gate_config\",\n        ]\n\n        // Read metadata\n        const response = await fetch(\"/rest/system_control\");\n        const system_control_data = await response.json();\n        config[\"unique_id\"] = system_control_data[\"s0\"];\n        config[\"firmware_version\"] = system_control_data[\"s1\"];\n        config[\"vcs_hash\"] = system_control_data[\"s2\"];\n        config[\"config\"] = {};\n\n        // Fetch data from endpoints\n        for (const endpoint of endpoints) {\n            const response = await fetch(endpoint);\n            const data = await response.json();\n            config[\"config\"][endpoint] = data;\n        }\n\n        // download as a file\n        const blob = new Blob([JSON.stringify(config, null, \"\\t\")], {type: \'application/json\'});\n        const url = URL.createObjectURL(blob);\n        const a = document.createElement(\'a\');\n        a.href = url;\n        a.download = \"opentrickler_\"+config[\"unique_id\"]+\"_config.json\";\n        a.click();\n        URL.revokeObjectURL(url);\n    }\n\n    async function onImportConfigClicked() {\n        const input = document.createElement(\'input\');\n        input.setAttribute(\'type\', \'file\')\n        input.setAttribute(\'multiple\', \'false\')\n        input.setAttribute(\'accept\', \'.json\')\n\n        input.onchange = (event) => {\n            const file = event.target.files[0];\n            if (!file) {\n                return;\n            }\n\n            // Setup the callbacks\n            const reader = new FileReader();\n            reader.onload = (event2) => {\n                try {\n                    const data = JSON.parse(reader.result);\n    \n                    // Process data\n                    const source_firmware_version = data[\"firmware_version\"];\n                    const source_unique_id = data[\"unique_id\"];\n                    const source_vcs_hash = data[\"vcs_hash\"];\n                    const config = data[\"config\"];\n\n                    // Restore settings\n                    for (const [endpoint, config_data] of Object.entries(config)) {\n                        const paramData = new FormData();\n                        for (const [key, value] of Object.entries(config_data)) {\n                            paramData.append(key, value);\n                        }\n\n                        // Create URI\n                        const queryString = new URLSearchParams(paramData).toString();\n                        const uri = new URL(endpoint + \"?\", window.location.origin);\n                        uri.search = queryString;\n                        fetch(uri);\n                    }\n\n                    // Update form\n                    const systemControlForm = document.getElementById(\"systemControlForm\");\n                    systemControlForm.elements[\"s4\"].value = true;  // Save to EEPROM\n                    systemControlForm.elements[\"s5\"].value = true;  // Reboot\n                    \n                    // Prompt user to save and reboot\n                    const applyBtn = document.getElementById(\"system_control_apply_btn\");\n                    applyBtn.click();\n                } \n                catch (exception) {\n                    console.error(exception);\n\n                    // Show warning \n                    const settingsRestoreFailedDialog = document.getElementById(\"settingsRestoreFailedDialog\");\n                    const settingsRestoreFailedText = document.getElementById(\"settingsRestoreFailedText\");\n\n                    settingsRestoreFailedText.innerHTML = `<h3 class=\"font-bold text-lg\">Failed to Restore Settings</h3><p class=\"py-4\">${exception}</p>`\n                    settingsRestoreFailedDialog.showModal();\n                }\n            }\n\n            reader.readAsText(file);\n        }\n        input.click();\n    }\n\n    // Error handling functions\n    function refreshErrors() {\n        fetch(\"/rest/errors\")\n        .then(response => response.json())\n        .then(data => {\n            const count = data.count;\n            const errors = data.errors;\n\n            // Update badge\n            const badge = document.getElementById(\"errorCountBadge\");\n            badge.innerText = count + \" error\" + (count !== 1 ? \"s\" : \"\");\n            if (count > 0) {\n                badge.classList.remove(\"badge-success\");\n                badge.classList.add(\"badge-error\");\n            } else {\n                badge.classList.remove(\"badge-error\");\n                badge.classList.add(\"badge-success\");\n            }\n\n            // Update error list\n            const container = document.getElementById(\"errorListContainer\");\n            if (count === 0) {\n                container.innerHTML = \'<div class=\"text-center text-gray-500\">No errors</div>\';\n            } else {\n                let html = \'\';\n                for (const err of errors) {\n                    html += `<div class=\"alert alert-error\">\n                        <span class=\"font-mono\">[${err.cat}:${err.code}]</span>\n                        <span>${err.msg}</span>\n                    </div>`;\n                }\n                container.innerHTML = html;\n            }\n        })\n        .catch(error => {\n            console.error(\"Error fetching errors:\", error);\n        });\n    }\n\n    function clearErrors() {\n        fetch(\"/rest/errors?clear=1\")\n        .then(response => response.json())\n        .then(data => {\n            refreshErrors();\n        })\n        .catch(error => {\n            console.error(\"Error clearing errors:\", error);\n        });\n    }\nfunction resetToAP() {        if (confirm(\"This will disable WiFi and reboot into AP mode. Continue?\")) {            fetch(\"/rest/wireless_config?w4=false&save=true\")            .then(() => {                fetch(\"/rest/system_control?s4=true&s5=true\");                alert(\"Rebooting to AP mode... Connect to OpenTrickler WiFi network.\");            })            .catch(() => alert(\"Failed to reset to AP mode.\"));        }    }\n\n    function saveDisplayAndReboot() {\n        const form = document.getElementById(\"displayConfigForm\");\n        const formData = new FormData(form);\n        const displayType = formData.get(\"d0\");\n        const rotation = formData.get(\"d1\");\n        const brightness = formData.get(\"d2\");\n        const invertedEncoder = formData.get(\"d3\");\n        const displayNames = [\"Mini 12864\", \"TFT35 V3.0.1\", \"TFT43 V3.0\"];\n\n        if (confirm(`Save display settings and reboot? The device will restart.`)) {\n            fetch(`/rest/display_config?d0=${displayType}&d1=${rotation}&d2=${brightness}&d3=${invertedEncoder}&ee=true`)\n            .then(() => {\n                fetch(\"/rest/system_control?s4=true&s5=true\");\n                alert(\"Display settings saved. Rebooting...\");\n            })\n            .catch(() => alert(\"Failed to save display settings.\"));\n        }\n    }\n\n    function onDisplayTypeChanged() {\n        const displayType = document.getElementById(\"displayTypeSelect\").value;\n        const brightnessGroup = document.getElementById(\"brightnessGroup\");\n        const rotationSelect = document.getElementById(\"displayRotationSelect\");\n\n        // Show/hide settings based on display type\n        if (displayType === \"0\") {\n            // Mini 12864: hide brightness, limit rotation to 0/180\n            brightnessGroup.style.display = \"none\";\n            rotationSelect.querySelectorAll(\"option\").forEach(opt => {\n                opt.style.display = (opt.value === \"0\" || opt.value === \"2\") ? \"block\" : \"none\";\n            });\n        } else {\n            // TFT35/TFT43: show brightness, all rotations available\n            brightnessGroup.style.display = \"block\";\n            rotationSelect.querySelectorAll(\"option\").forEach(opt => {\n                opt.style.display = \"block\";\n            });\n        }\n        // Encoder setting shown for all display types\n    }\n\n    function updateBrightnessLabel() {\n        const slider = document.getElementById(\"displayBrightnessSlider\");\n        const label = document.getElementById(\"brightnessLabel\");\n        label.innerText = slider.value;\n    }\n\n    function loadDisplayConfig() {\n        fetch(\"/rest/display_config\")\n        .then(r => r.json())\n        .then(data => {\n            document.getElementById(\"displayTypeSelect\").value = data.d0 || 0;\n            document.getElementById(\"displayRotationSelect\").value = data.d1 || 0;\n            document.getElementById(\"displayBrightnessSlider\").value = data.d2 !== undefined ? data.d2 : 255;\n            updateBrightnessLabel();\n            // Set inverted encoder\n            const encoderSelect = document.querySelector(\"#displayConfigForm select[name=\'d3\']\");\n            if (encoderSelect) encoderSelect.value = data.d3 ? \"true\" : \"false\";\n            onDisplayTypeChanged();\n        })\n        .catch(() => {});\n    }\n\n    // AI Tuning functions\n    var aiTuningPollId = null;\n\n    function startAiTuning() {\n        const profileIdx = document.getElementById(\"aiTuningProfileSelect\").value;\n        const mode = document.getElementById(\"aiTuningModeSelect\").value;\n        const uri = `/rest/ai_tuning_start?profile_idx=${profileIdx}&mode=${mode}`;\n\n        fetch(uri)\n        .then(response => response.json())\n        .then(data => {\n            if (data.success) {\n                // Update UI\n                document.getElementById(\"aiTuningStartBtn\").disabled = true;\n                document.getElementById(\"aiTuningCancelBtn\").disabled = false;\n                document.getElementById(\"aiTuningApplyBtn\").disabled = true;\n                document.getElementById(\"aiTuningProfileSelect\").disabled = true;\n                document.getElementById(\"aiTuningModeSelect\").disabled = true;\n\n                // Start polling\n                pollAiTuningStatus();\n            } else {\n                alert(\"Failed to start tuning: \" + data.error);\n            }\n        })\n        .catch(error => {\n            console.error(\"Error starting AI tuning:\", error);\n            alert(\"Error starting AI tuning\");\n        });\n    }\n\n    function cancelAiTuning() {\n        fetch(\"/rest/ai_tuning_cancel\")\n        .then(response => response.json())\n        .then(data => {\n            if (data.success) {\n                stopAiTuningPoll();\n                resetAiTuningUI();\n            }\n        })\n        .catch(error => {\n            console.error(\"Error cancelling AI tuning:\", error);\n        });\n    }\n\n    function applyAiTuning() {\n        fetch(\"/rest/ai_tuning_apply\")\n        .then(response => response.json())\n        .then(data => {\n            if (data.success) {\n                alert(\"Parameters applied and saved to profile!\");\n                resetAiTuningUI();\n            } else {\n                alert(\"Failed to apply: \" + data.error);\n            }\n        })\n        .catch(error => {\n            console.error(\"Error applying AI tuning:\", error);\n            alert(\"Error applying parameters\");\n        });\n    }\n\n    function pollAiTuningStatus() {\n        fetch(\"/rest/ai_tuning_status\")\n        .then(response => response.json())\n        .then(data => {\n            updateAiTuningUI(data);\n\n            // Continue polling if active\n            if (data.is_active) {\n                aiTuningPollId = setTimeout(pollAiTuningStatus, 500);\n            } else {\n                stopAiTuningPoll();\n            }\n        })\n        .catch(error => {\n            console.error(\"Error polling AI tuning status:\", error);\n            stopAiTuningPoll();\n        });\n    }\n\n    function stopAiTuningPoll() {\n        if (aiTuningPollId) {\n            clearTimeout(aiTuningPollId);\n            aiTuningPollId = null;\n        }\n    }\n\n    function updateAiTuningUI(data) {\n        // Update state badge\n        const stateBadge = document.getElementById(\"aiTuningState\");\n        stateBadge.innerText = data.state;\n        stateBadge.className = \"badge\";\n        if (data.state === \"idle\") {\n            stateBadge.classList.add(\"badge-neutral\");\n        } else if (data.state === \"complete\") {\n            stateBadge.classList.add(\"badge-success\");\n        } else if (data.state === \"error\") {\n            stateBadge.classList.add(\"badge-error\");\n        } else {\n            stateBadge.classList.add(\"badge-primary\");\n        }\n\n        // Update progress\n        document.getElementById(\"aiTuningProgress\").innerText = data.progress_percent + \"%\";\n        document.getElementById(\"aiTuningProgressBar\").value = data.progress_percent;\n        document.getElementById(\"aiTuningDrops\").innerText = data.drops_completed + \" / \" + data.drops_target;\n\n        // Show/hide current params\n        const currentParamsDiv = document.getElementById(\"aiTuningCurrentParams\");\n        if (data.is_active && data.current_params) {\n            currentParamsDiv.style.display = \"block\";\n            document.getElementById(\"aiCurrentCoarseKp\").innerText = data.current_params.coarse_kp.toFixed(3);\n            document.getElementById(\"aiCurrentCoarseKd\").innerText = data.current_params.coarse_kd.toFixed(3);\n            document.getElementById(\"aiCurrentFineKp\").innerText = data.current_params.fine_kp.toFixed(3);\n            document.getElementById(\"aiCurrentFineKd\").innerText = data.current_params.fine_kd.toFixed(3);\n        } else {\n            currentParamsDiv.style.display = \"none\";\n        }\n\n        // Show/hide recommended params\n        const recParamsDiv = document.getElementById(\"aiTuningRecommendedParams\");\n        if (data.is_complete && data.recommended_params) {\n            recParamsDiv.style.display = \"block\";\n            document.getElementById(\"aiRecCoarseKp\").innerText = data.recommended_params.coarse_kp.toFixed(3);\n            document.getElementById(\"aiRecCoarseKd\").innerText = data.recommended_params.coarse_kd.toFixed(3);\n            document.getElementById(\"aiRecFineKp\").innerText = data.recommended_params.fine_kp.toFixed(3);\n            document.getElementById(\"aiRecFineKd\").innerText = data.recommended_params.fine_kd.toFixed(3);\n\n            if (data.statistics) {\n                document.getElementById(\"aiStatOverthrow\").innerText = data.statistics.avg_overthrow.toFixed(2) + \" gr\";\n                document.getElementById(\"aiStatTime\").innerText = data.statistics.avg_time.toFixed(1) + \" ms\";\n                document.getElementById(\"aiStatConsistency\").innerText = data.statistics.consistency_score.toFixed(1) + \"%\";\n            }\n\n            // Enable apply button\n            document.getElementById(\"aiTuningApplyBtn\").disabled = false;\n            document.getElementById(\"aiTuningStartBtn\").disabled = false;\n            document.getElementById(\"aiTuningCancelBtn\").disabled = true;\n            document.getElementById(\"aiTuningProfileSelect\").disabled = false;\n            document.getElementById(\"aiTuningModeSelect\").disabled = false;\n        } else {\n            recParamsDiv.style.display = \"none\";\n        }\n\n        // Handle error state - show best params found and allow apply\n        if (data.state === \"error\") {\n            const recParamsDiv = document.getElementById(\"aiTuningRecommendedParams\");\n            recParamsDiv.style.display = \"block\";\n\n            if (data.best_params) {\n                document.getElementById(\"aiRecCoarseKp\").innerText = data.best_params.coarse_kp.toFixed(3);\n                document.getElementById(\"aiRecCoarseKd\").innerText = data.best_params.coarse_kd.toFixed(3);\n                document.getElementById(\"aiRecFineKp\").innerText = data.best_params.fine_kp.toFixed(3);\n                document.getElementById(\"aiRecFineKd\").innerText = data.best_params.fine_kd.toFixed(3);\n            }\n\n            // Show error message\n            if (data.error_message) {\n                document.getElementById(\"aiStatOverthrow\").innerText = \"Error\";\n                document.getElementById(\"aiStatTime\").innerText = data.error_message;\n                document.getElementById(\"aiStatConsistency\").innerText = \"-\";\n            }\n\n            // Enable apply button for best values\n            document.getElementById(\"aiTuningApplyBtn\").disabled = false;\n            document.getElementById(\"aiTuningStartBtn\").disabled = false;\n            document.getElementById(\"aiTuningCancelBtn\").disabled = true;\n            document.getElementById(\"aiTuningProfileSelect\").disabled = false;\n            document.getElementById(\"aiTuningModeSelect\").disabled = false;\n        }\n\n        // Handle completion\n        if (!data.is_active && !data.is_complete && data.state !== \"error\") {\n            // Cancelled\n            document.getElementById(\"aiTuningStartBtn\").disabled = false;\n            document.getElementById(\"aiTuningCancelBtn\").disabled = true;\n            document.getElementById(\"aiTuningProfileSelect\").disabled = false;\n            document.getElementById(\"aiTuningModeSelect\").disabled = false;\n        }\n    }\n\n    function resetAiTuningUI() {\n        document.getElementById(\"aiTuningStartBtn\").disabled = false;\n        document.getElementById(\"aiTuningCancelBtn\").disabled = true;\n        document.getElementById(\"aiTuningApplyBtn\").disabled = true;\n        document.getElementById(\"aiTuningProfileSelect\").disabled = false;\n        document.getElementById(\"aiTuningModeSelect\").disabled = false;\n        document.getElementById(\"aiTuningState\").innerText = \"Idle\";\n        document.getElementById(\"aiTuningState\").className = \"badge badge-neutral\";\n        document.getElementById(\"aiTuningProgress\").innerText = \"0%\";\n        document.getElementById(\"aiTuningProgressBar\").value = 0;\n        document.getElementById(\"aiTuningDrops\").innerText = \"0 / 0\";\n        document.getElementById(\"aiTuningCurrentParams\").style.display = \"none\";\n        document.getElementById(\"aiTuningRecommendedParams\").style.display = \"none\";\n    }\n\n    function loadProfileDropdowns() {\n        fetch(\"/rest/profile_summary\")\n        .then(response => response.json())\n        .then(data => {\n            const profiles = data[\"s0\"];  // Object: {\"0\":\"name\", \"1\":\"name2\", ...}\n            const currentIdx = data[\"s1\"];\n\n            // Update all profile dropdowns\n            const dropdowns = [\n                document.getElementById(\"aiTuningProfileSelect\"),\n                document.getElementById(\"select_profile_option\"),\n                document.getElementById(\"quickChangeProfileSelect\")\n            ];\n\n            dropdowns.forEach(select => {\n                if (!select) return;\n                // Clear existing options\n                select.innerHTML = \'\';\n                // Add options with profile names (iterate object keys)\n                for (const idx in profiles) {\n                    const option = document.createElement(\"option\");\n                    option.value = idx;\n                    const name = profiles[idx] ? profiles[idx].trim() : \'\';\n                    if (name && name.length > 0) {\n                        option.text = name;\n                    } else {\n                        option.text = \"#\" + idx;\n                    }\n                    select.appendChild(option);\n                }\n            });\n\n            // Set main profile dropdown to current profile\n            const mainSelect = document.getElementById(\"select_profile_option\");\n            if (mainSelect && currentIdx !== undefined) {\n                mainSelect.value = currentIdx;\n                populateProfileSelection(mainSelect);\n            }\n\n            // Also set AI tuning dropdown to current profile\n            const aiSelect = document.getElementById(\"aiTuningProfileSelect\");\n            if (aiSelect && currentIdx !== undefined) {\n                aiSelect.value = currentIdx;\n            }\n        })\n        .catch(error => {\n            console.error(\"Error loading profiles:\", error);\n        });\n    }\n\n    // Alias for backward compatibility\n    function loadAiTuningProfiles() {\n        loadProfileDropdowns();\n    }\n\n    function loadAiTuningThresholds() {\n        fetch(\"/rest/charge_mode_config\")\n        .then(response => response.json())\n        .then(data => {\n            document.getElementById(\"aiCoarseThreshold\").value = data.c5;\n            document.getElementById(\"aiFineThreshold\").value = data.c6;\n            document.getElementById(\"aiCoarseTimeTarget\").value = data.c13;\n            document.getElementById(\"aiTotalTimeTarget\").value = data.c14;\n        })\n        .catch(error => {\n            console.error(\"Error loading thresholds:\", error);\n        });\n    }\n\n    function saveAiTuningThresholds() {\n        const c5 = document.getElementById(\"aiCoarseThreshold\").value;\n        const c6 = document.getElementById(\"aiFineThreshold\").value;\n        const c13 = document.getElementById(\"aiCoarseTimeTarget\").value;\n        const c14 = document.getElementById(\"aiTotalTimeTarget\").value;\n\n        const uri = `/rest/charge_mode_config?c5=${c5}&c6=${c6}&c13=${c13}&c14=${c14}&ee=true`;\n\n        fetch(uri)\n        .then(response => response.json())\n        .then(data => {\n            alert(\"Thresholds saved!\");\n        })\n        .catch(error => {\n            console.error(\"Error saving thresholds:\", error);\n            alert(\"Error saving thresholds\");\n        });\n    }\n\n    function loadAiTuningHistory() {\n        fetch(\"/rest/ai_tuning_history\")\n        .then(response => response.json())\n        .then(data => {\n            document.getElementById(\"aiHistoryCount\").innerText = data.count + \" drops\";\n\n            // Show/hide suggestions section\n            const sugSection = document.getElementById(\"aiSuggestedSection\");\n            if (data.has_suggestions && data.suggested) {\n                sugSection.style.display = \"block\";\n                document.getElementById(\"aiSugCoarseKp\").innerText = data.suggested.coarse_kp.toFixed(2);\n                document.getElementById(\"aiSugCoarseKd\").innerText = data.suggested.coarse_kd.toFixed(2);\n                document.getElementById(\"aiSugFineKp\").innerText = data.suggested.fine_kp.toFixed(2);\n                document.getElementById(\"aiSugFineKd\").innerText = data.suggested.fine_kd.toFixed(2);\n            } else {\n                sugSection.style.display = \"none\";\n            }\n\n            const tbody = document.getElementById(\"aiHistoryTableBody\");\n            tbody.innerHTML = \"\";\n\n            if (data.count === 0) {\n                tbody.innerHTML = \'<tr><td colspan=\"4\" class=\"text-center text-gray-500\">No history yet</td></tr>\';\n                return;\n            }\n\n            for (let i = 0; i < data.drops.length; i++) {\n                const drop = data.drops[i];\n                const row = document.createElement(\"tr\");\n                const overthrowClass = drop.overthrow > 0.02 ? \'text-error\' : drop.overthrow < -0.02 ? \'text-warning\' : \'text-success\';\n                row.innerHTML = `\n                    <td>${i + 1}</td>\n                    <td>#${drop.profile}</td>\n                    <td class=\"${overthrowClass}\">${drop.overthrow >= 0 ? \'+\' : \'\'}${drop.overthrow.toFixed(3)}g</td>\n                    <td>${(drop.time / 1000).toFixed(1)}s</td>\n                `;\n                tbody.appendChild(row);\n            }\n        })\n        .catch(error => {\n            console.error(\"Error loading history:\", error);\n        });\n    }\n\n    function applyRefinedParams() {\n        const profileIdx = document.getElementById(\"aiTuningProfileSelect\").value;\n        if (!confirm(`Apply refined PID values to profile #${parseInt(profileIdx) + 1}?`)) {\n            return;\n        }\n\n        fetch(\"/rest/ai_tuning_apply_refined?profile_idx=\" + profileIdx)\n        .then(response => response.json())\n        .then(data => {\n            if (data.success) {\n                alert(\"Refined values applied successfully!\");\n                loadAiTuningHistory();\n            } else {\n                alert(\"Error: \" + (data.error || \"Failed to apply refined values\"));\n            }\n        })\n        .catch(error => {\n            console.error(\"Error applying refined values:\", error);\n            alert(\"Error applying refined values\");\n        });\n    }\n\n    function clearAiTuningHistory() {\n        if (!confirm(\"Clear all ML learning history?\")) {\n            return;\n        }\n\n        fetch(\"/rest/ai_tuning_clear_history\")\n        .then(response => response.json())\n        .then(data => {\n            if (data.success) {\n                loadAiTuningHistory();\n            }\n        })\n        .catch(error => {\n            console.error(\"Error clearing history:\", error);\n        });\n    }\n\n    // Start the long polling process when the page loads\n    if (document.readyState != \"loading\") {\n        loadProfileDropdowns();\n        onNavButtonClicked(\'trickler\');\n    }\n    else {\n        document.addEventListener(\'DOMContentLoaded\', function() {\n            loadProfileDropdowns();\n            onNavButtonClicked(\'trickler\');\n        });\n    }\n\n\n    // Motors state functions\n    async function loadMotorsState() {\n        try {\n            const response = await fetch(\'/rest/motors_state\');\n            const data = await response.json();\n            \n            document.getElementById(\'motorsEnabledToggle\').checked = data.motors_enabled;\n            \n            let statusText = \'Motors: \';\n            if (!data.motors_enabled) {\n                statusText += \'Disabled by user\';\n                document.getElementById(\'motorsStatusAlert\').className = \'alert alert-warning\';\n            } else if (data.motors_detected) {\n                statusText += \'Enabled and detected\';\n                document.getElementById(\'motorsStatusAlert\').className = \'alert alert-success\';\n            } else {\n                statusText += \'Enabled but not detected\';\n                document.getElementById(\'motorsStatusAlert\').className = \'alert alert-error\';\n            }\n            document.getElementById(\'motorsStatusText\').textContent = statusText;\n        } catch (e) {\n            document.getElementById(\'motorsStatusText\').textContent = \'Error loading motors state\';\n            document.getElementById(\'motorsStatusAlert\').className = \'alert alert-error\';\n        }\n    }\n    \n    async function onMotorsEnabledChange() {\n        const enabled = document.getElementById(\'motorsEnabledToggle\').checked;\n        try {\n            await fetch(\'/rest/motors_state?enable=\' + enabled);\n            loadMotorsState();\n        } catch (e) {\n            alert(\'Failed to update motors setting\');\n        }\n    }\n\n    // Fetch firmware version\n    fetch(\'/rest/system_control\').then(r => r.json()).then(d => {\n        const ver = d.s1 || \'?.?\';\n        if (document.getElementById(\'navVersion\')) document.getElementById(\'navVersion\').textContent = \'v\' + ver;\n    }).catch(() => {});\n\n</script>\n\n</body>\n\n</html>";

#endif  //  WEB_PORTAL_HTML_H_
