name: Build Firmware

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Clone all dependencies
      run: |
        echo "Cloning project dependencies..."
        git clone --depth 1 https://github.com/raspberrypi/FreeRTOS-Kernel.git library/FreeRTOS-Kernel
        git clone --depth 1 https://github.com/olikraus/u8g2.git library/u8g2
        git clone --depth 1 https://github.com/terjeio/Trinamic-library.git library/Trinamic-library

    - name: Install ARM toolchain
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake gcc-arm-none-eabi libnewlib-arm-none-eabi build-essential

    - name: Setup Pico SDK with RP2350/Pico2W support
      run: |
        echo "Cloning latest Pico SDK..."
        rm -rf library/pico-sdk
        git clone --depth 1 https://github.com/raspberrypi/pico-sdk.git library/pico-sdk
        cd library/pico-sdk
        echo "Initializing essential SDK submodules (excluding broken TinyUSB)..."
        git submodule update --init --depth 1 lib/btstack
        git submodule update --init --depth 1 lib/cyw43-driver
        git submodule update --init --depth 1 lib/lwip
        git submodule update --init --depth 1 lib/mbedtls
        echo "SDK ready (CMake will handle remaining dependencies)"
        
    - name: Build for Pico 2W
      run: |
        mkdir build
        cd build
        cmake .. -DPICO_PLATFORM=rp2350 -DPICO_BOARD=pico2_w -DBUILD_OTA_BOOTLOADER=ON -DUSE_OTA_LINKER_SCRIPT=ON -DOTA_TEST_MODE=OFF
        make -j$(nproc)

    - name: Create combined image for Pico 2W
      run: |
        python3 create_combined_uf2.py \
          build/src/bootloader/bootloader.uf2 \
          build/app.uf2 \
          build/combined.uf2

    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware-pico2w
        path: |
          build/combined.uf2
          build/src/bootloader/bootloader.uf2
          build/src/bootloader/bootloader.bin
          build/src/bootloader/bootloader.elf
          build/app.uf2
          build/app.bin
          build/app.elf
          
    - name: Build for Pico W (RP2040)
      run: |
        rm -rf build
        mkdir build
        cd build
        cmake .. -DPICO_BOARD=pico_w -DBUILD_OTA_BOOTLOADER=ON -DUSE_OTA_LINKER_SCRIPT=ON -DOTA_TEST_MODE=OFF
        make -j$(nproc)

    - name: Create combined image for Pico W
      run: |
        python3 create_combined_bin.py \
          build/src/bootloader/bootloader.bin \
          build/app.bin \
          build/combined.uf2

    - name: Upload firmware artifacts (Pico W)
      uses: actions/upload-artifact@v4
      with:
        name: firmware-picow
        path: |
          build/combined.uf2
          build/src/bootloader/bootloader.uf2
          build/src/bootloader/bootloader.bin
          build/src/bootloader/bootloader.elf
          build/app.uf2
          build/app.bin
          build/app.elf
